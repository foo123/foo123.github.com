/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 1.0.0
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,e,n){"use strict";"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[e]=n.call(t)):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(e)?define(e,["module"],function(e){return n.moduleUri=e.uri,n.call(t)}):e in t||(t[e]=n.call(t)||1)&&"function"==typeof define&&define.amd&&define(function(){return t[e]})}("undefined"!=typeof self?self:this,"HAAR",function(){"use strict";var e,_,t={VERSION:"1.0.0"},n="prototype",A=void 0,v="undefined"!=typeof Float32Array?Float32Array:Array,m="undefined"!=typeof Uint8Array?Uint8Array:Array,x=Math.abs,a=Math.max,P=Math.min,f=(Math.floor,Math.round),i=(Math.sqrt,Array[n].slice);function g(e,t,n){var i,a,l,r,o,h,c,u=e.length,s=new Array(u),d=[],g=0,f=!1;for(l=0;l<u;l++)s[l]=0;for(l=0;l<u;l++){for(f=!1,r=0;r<l;r++)e[r].almostEqual(e[l])&&(f=!0,s[l]=s[r]);f||(s[l]=g,g++)}for(i=new Array(g),a=new Array(g),l=0;l<g;l++)i[l]=0,a[l]=new _;for(l=0;l<u;l++)i[c=s[l]]++,a[c].add(e[l]);for(l=0;l<g;l++)t<=(o=i[l])&&(c=new _((h=1/(o+o))*(2*a[l].x+o),h*(2*a[l].y+o),h*(2*a[l].width+o),h*(2*a[l].height+o)),d.push(c));for(1!=n&&(n=1/n),u=d.length,l=0;l<u;l++)for(r=l+1;r<u;r++)!d[l].isInside&&d[l].inside(d[r])?d[l].isInside=!0:!d[r].isInside&&d[r].inside(d[l])&&(d[r].isInside=!0);for(l=u;0<=--l;)d[l].isInside?d.splice(l,1):(1!=n&&d[l].scale(n),d[l].round().computeArea());return d.sort(y)}function y(e,t){return e.area-t.area}function T(e,t){return e.index-t.index}function D(e){return e[1].length&&(e[0]=e[0].concat(e[1]).sort(T)),e[0]}function j(e){var t,n,i,a,l,r,o,h,c,u,s,d,g,f,y,w,v,m,x,S,p,I,C,q,R,b,H,_,A,P,T,D,j,L,M,W,z,E,k,F,U,$,O,V,N,B,G=G||Math.sqrt,J=[],K=e.haardata,Q=K.stages,X=e.scaledSelection,Y=e.width,Z=e.height,ee=X.width,te=X.height,ne=Y*Z,ie=ne-1,ae=K.size1,le=K.size2,re=X.x,oe=X.y,he=Q.length,ce=e.cannyLow,ue=e.cannyHigh,se=e.canny,de=e.integral,ge=e.squares,fe=e.tilted,ye=e.scale,we=e.increment,ve=e.i||0,me=e.doCannyPruning;for(v=Y-1,0,m=ne-Y,t=~~((i=~~(ye*ae))*we),h=(a=~~(ye*le))*Y,f=ee-i,y=te-a,x=1/(i*a),o=(r=oe)*(c=(n=~~(a*we))*Y);r<y;r+=n,o+=c)for(l=re;l<f;l+=t)if(s=(u=l-1+o-Y)+i,g=(d=u+h)+i,u=u<0?0:ie<u?ie:u,s=s<0?0:ie<s?ie:s,d=d<0?0:ie<d?ie:d,g=g<0?0:ie<g?ie:g,!me||!((I=x*(se[g]-se[d]-se[s]+se[u]))<ce||ue<I)){for(S=x*(de[g]-de[d]-de[s]+de[u]),p=1<(p=x*(ge[g]-ge[d]-ge[s]+ge[u])-S*S)?G(p):1,C=!0,w=0;w<he;w++){for(R=(q=Q[w]).thres,H=(b=q.trees).length,_=B=0;_<H;_++)for(P=b[_].feats,A=0;;){if(j=(D=(T=P[A]).rects).length,L=T.thres,M=0,T.tilt)for(W=0;W<j;W++)E=l+~~(ye*(z=D[W])[0]),k=(r-1+~~(ye*z[1]))*Y,F=l+~~(ye*(z[0]+z[2])),U=(r-1+~~(ye*(z[1]+z[2])))*Y,$=l+~~(ye*(z[0]-z[3])),O=(r-1+~~(ye*(z[1]+z[3])))*Y,E=E<0?0:v<E?v:E,F=F<0?0:v<F?v:F,$=$<0?0:v<$?v:$,V=(V=l+~~(ye*(z[0]+z[2]-z[3])))<0?0:v<V?v:V,k=k<0?0:m<k?m:k,U=U<0?0:m<U?m:U,O=O<0?0:m<O?m:O,N=(N=(r-1+~~(ye*(z[1]+z[2]+z[3])))*Y)<0?0:m<N?m:N,M+=z[4]*(fe[V+N]-fe[$+O]-fe[F+U]+fe[E+k]);else for(W=0;W<j;W++)E=(E=l-1+~~(ye*(z=D[W])[0]))<0?0:v<E?v:E,F=(F=l-1+~~(ye*(z[0]+z[2])))<0?0:v<F?v:F,k=(k=Y*(r-1+~~(ye*z[1])))<0?0:m<k?m:k,U=(U=Y*(r-1+~~(ye*(z[1]+z[3]))))<0?0:m<U?m:U,M+=z[4]*(de[F+U]-de[E+U]-de[F+k]+de[E+k]);if(M*x<L*p?0:1){if(T.has_r){B+=T.r_val;break}A=T.r_node}else{if(T.has_l){B+=T.l_val;break}A=T.l_node}}if(!(C=R<B))break}C&&J.push({index:ve,x:l,y:r,width:i,height:a})}return J}function L(e,t){for(var n=0,i=t.length;n<i;n++)t[n]=new _(t[n]);e.objects=g(t,e.min_neighbors,e.Ratio,e.Selection),e.Ready=!0,e.onComplete&&e.onComplete.call(e)}return(e=t.Detector=function(e,t){var n=this;n.haardata=e||null,n.Ready=!1,n.doCannyPruning=!1,n.Canvas=null,n.Selection=null,n.scaledSelection=null,n.objects=null,n.TimeInterval=null,n.DetectInterval=30,n.Ratio=.5,n.cannyLow=20,n.cannyHigh=100,n.Parallel=t||null,n.onComplete=null})[n]={constructor:e,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var e=this;return e.DetectInterval&&clearTimeout(e.DetectInterval),e.DetectInterval=null,e.TimeInterval=null,e.haardata=null,e.Canvas=null,e.objects=null,e.Selection=null,e.scaledSelection=null,e.Ratio=null,e.origWidth=null,e.origHeight=null,e.width=null,e.height=null,e.doCannyPruning=null,e.cannyLow=null,e.cannyHigh=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Parallel=null,e.Ready=null,e.onComplete=null,e},clearCache:function(){var e=this;return e.haardata=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Selection=null,e.scaledSelection=null,e},cascade:function(e){return this.haardata=e||null,this},parallel:function(e){return this.Parallel=e||null,this},image:function(e,t,n){var i=this;if(e){var a,l,r,o,h,c,u,s,d,g=e instanceof HTMLVideoElement;i.Canvas||(i.Canvas=n||document.createElement("canvas")),d=i.Canvas,s=i.Ratio=A===t?.5:t,i.Ready=!1,o=i.origWidth=g?e.videoWidth:e.width,h=i.origHeight=g?e.videoHeight:e.height,c=i.width=d.width=f(s*o),u=i.height=d.height=f(s*h),(a=d.getContext("2d")).drawImage(e,0,0,o,h,0,0,c,u),r=function(e,t,n){var i,a,l,r,o,h,c,u=e.length,s=t*n,d=new m(s),g=new v(s),f=new v(s),y=new v(s);for(i=a=l=r=0;r<t;)c=4899*e[l]+9617*e[l+1]+1868*e[l+2]+8192>>>14,i+=c&=255,a+=c*c,d[r]=c,g[r]=i,f[r]=a,y[r]=c,r++,l+=4;for(h=1,l=(r=t)<<2,i=a=o=0;l<u;)c=4899*e[l]+9617*e[l+1]+1868*e[l+2]+8192>>>14,i+=c&=255,a+=c*c,d[r]=c,g[r]=g[r-t]+i,f[r]=f[r-t]+a,y[r]=y[r+1-t]+(c+d[r-t])+(1<h?y[r-t-t]:0)+(0<o?y[r-1-t]:0),r++,l+=4,t<=++o&&(h++,i=a=o=0);return{gray:d,integral:g,squares:f,tilted:y}}((l=a.getImageData(0,0,c,u)).data,l.width,l.height),i.integral=r.integral,i.squares=r.squares,i.tilted=r.tilted,i.canny=function(e,t,n){var i,a,l,r,o,h,c,u,s,d,g,f=e.length,y=new m(f),w=new v(f);for(i=0;i<t;i++)y[i]=0,y[i+t]=0,y[i+f-t]=0,y[i+f-t-t]=0,w[i]=0,w[i+f-t]=0;for(l=a=0;a<n;a++,l+=t)y[0+l]=0,y[1+l]=0,y[t-1+l]=0,w[(y[t-2+l]=0)+l]=0,w[t-1+l]=0;for(i=2;i<t-2;i++)for(r=0,a=2,l=t<<1;a<n-2;a++,l+=t)s=(u=(c=i+l)+t)+t,r=(e[(g=(d=c-t)-t)-2]<<1)+(e[d-2]<<2)+(e[c-2]<<2)+e[c-2]+(e[u-2]<<2)+(e[s-2]<<1)+(e[g-1]<<2)+(e[d-1]<<3)+e[d-1]+(e[c-1]<<4)-(e[c-1]<<2)+(e[u-1]<<3)+e[u-1]+(e[s-1]<<2)+(e[g]<<2)+e[g]+(e[d]<<4)-(e[d]<<2)+(e[c]<<4)-e[c]+(e[u]<<4)-(e[u]<<2)+(e[s]<<2)+e[s]+(e[1+g]<<2)+(e[d+1]<<3)+e[d+1]+(e[c+1]<<4)-(e[c+1]<<2)+(e[u+1]<<3)+e[u+1]+(e[s+1]<<2)+(e[2+g]<<1)+(e[d+2]<<2)+(e[c+2]<<2)+e[c+2]+(e[u+2]<<2)+(e[s+2]<<1),y[c]=((103*r+8192&4294967295)>>>14&255)>>>0;for(i=1;i<t-1;i++)for(a=1,l=t;a<n-1;a++,l+=t)u=(c=l+i)+t,o=0-y[(d=c-t)-1]+y[d+1]-y[c-1]-y[c-1]+y[c+1]+y[c+1]-y[u-1]+y[u+1],h=0+y[d-1]+y[d]+y[d]+y[d+1]-y[u-1]-y[u]-y[u]-y[u+1],w[c]=x(o)+x(h);for(r=i=0;i<t;)r+=w[i],w[i]=r,i++;for(i=t,r=l=0;i<f;)r+=w[i],w[i]=w[i-t]+r,i++,t<=++l&&(r=l=0);return w}(r.gray,c,u),r.gray=null,r.integral=null,r.squares=null,r.tilted=null,r=null}return i},interval:function(e){return 0<e&&(this.DetectInterval=e),this},cannyThreshold:function(e){return e&&A!==e.low&&(this.cannyLow=e.low),e&&A!==e.high&&(this.cannyHigh=e.high),this},select:function(){var e=i.call(arguments),t=e.length;return 1==t&&"auto"==e[0]||!t?this.Selection=null:this.Selection=_[n].data.apply(new _,e),this},complete:function(e){return this.onComplete=e||null,this},detect:function(e,t,n,i,a){var l,r,o,h=this,c=h.haardata,u=c.size1,s=c.size2,d=h.width,g=h.height,f=h.origWidth,y=h.origHeight,w=h.integral,v=h.squares,m=h.tilted,x=h.canny,S=h.cannyLow,p=h.cannyHigh;h.Selection||(h.Selection=new _(0,0,f,y)),(l=h.Selection).x="auto"==l.x?0:l.x,l.y="auto"==l.y?0:l.y,l.width="auto"==l.width?f:l.width,l.height="auto"==l.height?y:l.height,r=h.scaledSelection=l.clone().scale(h.Ratio).round(),e=A===e?1:e,t=A===t?1.25:t,n=A===n?.5:n,i=A===i?1:i,a=h.doCannyPruning=A===a||a,o=h.maxScale=P(r.width/u,r.height/s),h.scale=e,h.min_neighbors=i,h.scale_inc=t,h.increment=n,h.Ready=!1;var I=h.Parallel;if(I&&I.isSupported()){var C,q=[],R=0;for(C=e;C<=o;C*=t)q.push({haardata:c,width:d,height:g,scaledSelection:{x:r.x,y:r.y,width:r.width,height:r.height},integral:w,squares:v,tilted:m,doCannyPruning:a,canny:a?x:null,cannyLow:S,cannyHigh:p,maxScale:o,min_neighbors:i,scale_inc:t,increment:n,scale:C,i:R++});new I(q,{synchronous:!1}).require(T,j,D).map(j).reduce(D).then(function(e){L(h,e)})}else{var b=[],H=function(){h.scale<=h.maxScale?(b=b.concat(j(h)),h.scale*=h.scale_inc,h.TimeInterval=setTimeout(H,h.DetectInterval)):(clearTimeout(h.TimeInterval),L(h,b))};h.TimeInterval=setTimeout(H,h.DetectInterval)}return h},detectSync:function(e,t,n,i,a){var l,r,o=this,h=o.haardata.size1,c=o.haardata.size2;o.Selection||(o.Selection=new _(0,0,o.origWidth,o.origHeight)),o.Selection.x="auto"==o.Selection.x?0:o.Selection.x,o.Selection.y="auto"==o.Selection.y?0:o.Selection.y,o.Selection.width="auto"==o.Selection.width?o.origWidth:o.Selection.width,o.Selection.height="auto"==o.Selection.height?o.origHeight:o.Selection.height,o.scaledSelection=o.Selection.clone().scale(o.Ratio).round(),e=void 0===e?1:e,t=void 0===t?1.25:t,n=void 0===n?.5:n,i=void 0===i?1:i,o.doCannyPruning=void 0===a||a,r=o.maxScale=P(o.scaledSelection.width/h,o.scaledSelection.height/c),l=o.scale=e,o.min_neighbors=i,o.scale_inc=t,o.increment=n,o.Ready=!1;for(var u=[];l<=r;)u=u.concat(j(o)),o.scale=l*=t;for(var s=0,d=u.length;s<d;s++)u[s]=new _(u[s]);return o.objects=g(u,o.min_neighbors,o.Ratio,o.Selection),o.Ready=!0,o.objects}},e[n].selection=e[n].select,(_=t.Feature=function(e,t,n,i,a){this.data(e,t,n,i,a)})[n]={constructor:_,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(e,t,n,i,a){var l=this;return e&&e instanceof _?l.copy(e):e&&e instanceof Object?(l.x=e.x||0,l.y=e.y||0,l.width=e.width||0,l.height=e.height||0,l.index=e.index||0,l.area=e.area||0,l.isInside=e.isInside||!1):(l.x=e||0,l.y=t||0,l.width=n||0,l.height=i||0,l.index=a||0,l.area=0,l.isInside=!1),l},add:function(e){var t=this;return t.x+=e.x,t.y+=e.y,t.width+=e.width,t.height+=e.height,t},scale:function(e){var t=this;return t.x*=e,t.y*=e,t.width*=e,t.height*=e,t},round:function(){var e=this;return e.x=~~(e.x+.5),e.y=~~(e.y+.5),e.width=~~(e.width+.5),e.height=~~(e.height+.5),e},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(e){var t=this;return!!(t.x>=e.x&&t.y>=e.y&&t.x+t.width<=e.x+e.width&&t.y+t.height<=e.y+e.height)},contains:function(e){return e.inside(this)},equal:function(e){return!(e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)},almostEqual:function(e){var t=this,n=.2*a(e.width,t.width),i=.2*a(e.height,t.height);return!!(x(t.x-e.x)<=n&&x(t.y-e.y)<=i&&x(t.width-e.width)<=n&&x(t.height-e.height)<=i)},clone:function(){var e=this,t=new _;return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside,t},copy:function(e){var t=this;return e&&e instanceof _&&(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside),t},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}},t});