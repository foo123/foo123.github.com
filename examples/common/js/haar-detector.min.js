/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.7
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/!function(e,n,t){"use strict";var i,a="object"==typeof module&&module.exports,l="function"==typeof define&&define.amd;a?module.exports=(module.$deps=module.$deps||{})[n]=module.$deps[n]||t.call(e,{NODE:module})||1:l&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(n)?define(n,["require","exports","module"],function(n,i,a){return t.call(e,{AMD:a})}):n in e||(e[n]=i=t.call(e,{})||1)&&l&&define(n,[],function(){return i})}(this,"HAAR",function(e){return!function(e,n){function t(e,n,t){var i,a,l,r,h,o,u,s=e.length,c=n*t,d=new w(c),g=new y(c),f=new y(c),v=new y(c);for(r=0,l=0,i=a=0;n>r;)u=4899*e[l]+9617*e[l+1]+1868*e[l+2]+8192>>>14,u&=255,i+=u,a+=u*u,d[r]=u,g[r]=i,f[r]=a,v[r]=u,r++,l+=4;for(h=0,o=1,r=n,l=n<<2,i=a=0;s>l;)u=4899*e[l]+9617*e[l+1]+1868*e[l+2]+8192>>>14,u&=255,i+=u,a+=u*u,d[r]=u,g[r]=g[r-n]+i,f[r]=f[r-n]+a,v[r]=v[r+1-n]+(u+d[r-n])+(o>1?v[r-n-n]:0)+(h>0?v[r-1-n]:0),h++,r++,l+=4,h>=n&&(h=0,o++,i=a=0);return{gray:d,integral:g,squares:f,tilted:v}}function i(e,n,t){var i,a,l,r,h,o,u,s,c,d,g,f=e.length,x=new w(f),m=new y(f);for(i=0;n>i;i++)x[i]=0,x[i+n]=0,x[i+f-n]=0,x[i+f-n-n]=0,m[i]=0,m[i+f-n]=0;for(a=0,l=0;t>a;a++,l+=n)x[0+l]=0,x[1+l]=0,x[n-1+l]=0,x[n-2+l]=0,m[0+l]=0,m[n-1+l]=0;for(i=2;n-2>i;i++)for(r=0,a=2,l=n<<1;t-2>a;a++,l+=n)u=i+l,s=u+n,c=s+n,d=u-n,g=d-n,r=0+(e[g-2]<<1)+(e[d-2]<<2)+(e[u-2]<<2)+e[u-2]+(e[s-2]<<2)+(e[c-2]<<1)+(e[g-1]<<2)+(e[d-1]<<3)+e[d-1]+(e[u-1]<<4)-(e[u-1]<<2)+(e[s-1]<<3)+e[s-1]+(e[c-1]<<2)+(e[g]<<2)+e[g]+(e[d]<<4)-(e[d]<<2)+(e[u]<<4)-e[u]+(e[s]<<4)-(e[s]<<2)+(e[c]<<2)+e[c]+(e[g+1]<<2)+(e[d+1]<<3)+e[d+1]+(e[u+1]<<4)-(e[u+1]<<2)+(e[s+1]<<3)+e[s+1]+(e[c+1]<<2)+(e[g+2]<<1)+(e[d+2]<<2)+(e[u+2]<<2)+e[u+2]+(e[s+2]<<2)+(e[c+2]<<1),x[u]=((103*r+8192&4294967295)>>>14&255)>>>0;for(i=1;n-1>i;i++)for(a=1,l=n;t-1>a;a++,l+=n)u=l+i,s=u+n,d=u-n,h=0-x[d-1]+x[d+1]-x[u-1]-x[u-1]+x[u+1]+x[u+1]-x[s-1]+x[s+1],o=0+x[d-1]+x[d]+x[d]+x[d+1]-x[s-1]-x[s]-x[s]-x[s+1],m[u]=v(h)+v(o);for(i=0,r=0;n>i;)r+=m[i],m[i]=r,i++;for(i=n,l=0,r=0;f>i;)r+=m[i],m[i]=m[i-n]+r,i++,l++,l>=n&&(l=0,r=0);return m}function a(e,n,t){var i,a,r,h,o,u,s,c=e.length,g=new Array(c),f=[],y=0,w=!1;for(r=0;c>r;r++)g[r]=0;for(r=0;c>r;r++){for(w=!1,h=0;r>h;h++)e[h].almostEqual(e[r])&&(w=!0,g[r]=g[h]);w||(g[r]=y,y++)}for(i=new Array(y),a=new Array(y),r=0;y>r;r++)i[r]=0,a[r]=new d;for(r=0;c>r;r++)s=g[r],i[s]++,a[s].add(e[r]);for(r=0;y>r;r++)o=i[r],o>=n&&(u=1/(o+o),s=new d(u*(2*a[r].x+o),u*(2*a[r].y+o),u*(2*a[r].width+o),u*(2*a[r].height+o)),f.push(s));for(1!=t&&(t=1/t),c=f.length,r=0;c>r;r++)for(h=r+1;c>h;h++)!f[r].isInside&&f[r].inside(f[h])?f[r].isInside=!0:!f[h].isInside&&f[h].inside(f[r])&&(f[h].isInside=!0);for(r=c;--r>=0;)f[r].isInside?f.splice(r,1):(1!=t&&f[r].scale(t),f[r].round().computeArea());return f.sort(l)}function l(e,n){return e.area-n.area}function r(e,n){return e.index-n.index}function h(e){return e[1].length&&(e[0]=e[0].concat(e[1]).sort(r)),e[0]}function o(e){var n,t,i,a,l,r,h,o,u,c,d,g,f,y,w,v,x,m,p,I,S,q,C,A,H,R,b,D,T,_,P,M,L,j,E,W,z,k,F,O,$,N,U,V,B,G,J,K,Q,X=X||Math.sqrt,Y=[],Z=e.haardata,en=e.scaledSelection,nn=en.width,tn=en.height,an=nn*tn,ln=an-1,rn=Z.size1,hn=Z.size2,on=en.x,un=en.y,sn=Z.stages.length,cn=e.cannyLow,dn=e.cannyHigh,gn=e.canny,fn=e.integral,yn=e.squares,wn=e.tilted,vn=e.scale,xn=e.increment,mn=e.i||0,pn=e.doCannyPruning;for(w=0,v=nn-1,x=0,m=an-nn,i=~~(vn*rn),n=~~(i*xn),a=~~(vn*hn),t=~~(a*xn),u=a*nn,c=t*nn,l=un*c,xl=nn-i,yl=tn-a,p=i*a,I=1/p,h=un,o=l;yl>h;h+=t,o+=c)for(r=on;xl>r;r+=n)if(d=r-1+o-nn,g=d+i,f=d+u,y=f+i,d=0>d?0:d>ln?ln:d,g=0>g?0:g>ln?ln:g,f=0>f?0:f>ln?ln:f,y=0>y?0:y>ln?ln:y,!(pn&&(A=I*(gn[y]-gn[f]-gn[g]+gn[d]),cn>A||A>dn))){for(S=I*(fn[y]-fn[f]-fn[g]+fn[d]),q=I*(yn[y]-yn[f]-yn[g]+yn[d]),C=q-S*S,C=C>1?X(C):1,H=!0,s=0;sn>s;s++){for(R=Z.stages[s],b=R.thres,D=R.trees,T=D.length,Q=0,_=0;T>_;_++)for(L=D[_].feats,P=0;;){if(j=L[P],E=j.rects,W=E.length,z=j.thres,k=0,j.tilt)for(F=0;W>F;F++)O=E[F],$=r+~~(vn*O[0]),N=(h-1+~~(vn*O[1]))*nn,U=r+~~(vn*(O[0]+O[2])),V=(h-1+~~(vn*(O[1]+O[2])))*nn,B=r+~~(vn*(O[0]-O[3])),G=(h-1+~~(vn*(O[1]+O[3])))*nn,J=r+~~(vn*(O[0]+O[2]-O[3])),K=(h-1+~~(vn*(O[1]+O[2]+O[3])))*nn,$=w>$?w:$>v?v:$,U=w>U?w:U>v?v:U,B=w>B?w:B>v?v:B,J=w>J?w:J>v?v:J,N=x>N?x:N>m?m:N,V=x>V?x:V>m?m:V,G=x>G?x:G>m?m:G,K=x>K?x:K>m?m:K,k+=O[4]*(wn[J+K]-wn[B+G]-wn[U+V]+wn[$+N]);else for(F=0;W>F;F++)O=E[F],$=r-1+~~(vn*O[0]),U=r-1+~~(vn*(O[0]+O[2])),N=nn*(h-1+~~(vn*O[1])),V=nn*(h-1+~~(vn*(O[1]+O[3]))),$=w>$?w:$>v?v:$,U=w>U?w:U>v?v:U,N=x>N?x:N>m?m:N,V=x>V?x:V>m?m:V,k+=O[4]*(fn[U+V]-fn[$+V]-fn[U+N]+fn[$+N]);if(M=z*C>k*I?0:1){if(j.has_r){Q+=j.r_val;break}P=j.r_node}else{if(j.has_l){Q+=j.l_val;break}P=j.l_node}}if(H=Q>b?!0:!1,!H)break}H&&Y.push({index:mn,x:r,y:h,width:i,height:a})}return Y}function u(e,n){for(var t=0,i=n.length;i>t;t++)n[t]=new d(n[t]);e.objects=a(n,e.min_neighbors,e.Ratio,e.Selection),e.Ready=!0,e.onComplete&&e.onComplete.call(e)}var c,d,g=e.HAAR={VERSION:"0.4.7"},f="prototype",y="undefined"!=typeof Float32Array?Float32Array:Array,w="undefined"!=typeof Uint8Array?Uint8Array:Array,v=Math.abs,x=Math.max,m=Math.min,p=(Math.floor,Math.round),I=(Math.sqrt,Array[f].slice);c=g.Detector=function(e,n){var t=this;t.haardata=e||null,t.Ready=!1,t.doCannyPruning=!1,t.Canvas=null,t.Selection=null,t.scaledSelection=null,t.objects=null,t.TimeInterval=null,t.DetectInterval=30,t.Ratio=.5,t.cannyLow=20,t.cannyHigh=100,t.Parallel=n||null,t.onComplete=null},c[f]={constructor:c,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var e=this;return e.DetectInterval&&clearTimeout(e.DetectInterval),e.DetectInterval=null,e.TimeInterval=null,e.haardata=null,e.Canvas=null,e.objects=null,e.Selection=null,e.scaledSelection=null,e.Ratio=null,e.origWidth=null,e.origHeight=null,e.width=null,e.height=null,e.doCannyPruning=null,e.cannyLow=null,e.cannyHigh=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Parallel=null,e.Ready=null,e.onComplete=null,e},clearCache:function(){var e=this;return e.haardata=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Selection=null,e.scaledSelection=null,e},cascade:function(e){return this.haardata=e||null,this},parallel:function(e){return this.Parallel=e||null,this},image:function(e,a,l){var r=this;if(e){var h,o,u,s,c,d,g,f,y,w=e instanceof HTMLVideoElement;r.Canvas||(r.Canvas=l||document.createElement("canvas")),y=r.Canvas,f=r.Ratio=n===a?.5:a,r.Ready=!1,s=r.origWidth=w?e.videoWidth:e.width,c=r.origHeight=w?e.videoHeight:e.height,d=r.width=y.width=p(f*s),g=r.height=y.height=p(f*c),h=y.getContext("2d"),h.drawImage(e,0,0,s,c,0,0,d,g),o=h.getImageData(0,0,d,g),u=t(o.data,o.width,o.height),r.integral=u.integral,r.squares=u.squares,r.tilted=u.tilted,r.canny=i(u.gray,d,g),u.gray=null,u.integral=null,u.squares=null,u.tilted=null,u=null}return r},interval:function(e){return e>0&&(this.DetectInterval=e),this},cannyThreshold:function(e){return e&&n!==e.low&&(this.cannyLow=e.low),e&&n!==e.high&&(this.cannyHigh=e.high),this},select:function(){var e=I.call(arguments),n=e.length;return this.Selection=1==n&&"auto"==e[0]||!n?null:d[f].data.apply(new d,e),this},complete:function(e){return this.onComplete=e||null,this},detect:function(e,t,i,a,l){var s,c,g,f,y=this,w=y.haardata,v=w.size1,x=w.size2,p=y.width,I=y.height,S=y.origWidth,q=y.origHeight,C=y.integral,A=y.squares,H=y.tilted,R=y.canny,b=y.cannyLow,D=y.cannyHigh;y.Selection||(y.Selection=new d(0,0,S,q)),s=y.Selection,s.x="auto"==s.x?0:s.x,s.y="auto"==s.y?0:s.y,s.width="auto"==s.width?S:s.width,s.height="auto"==s.height?q:s.height,c=y.scaledSelection=s.clone().scale(y.Ratio).round(),e=n===e?1:e,t=n===t?1.25:t,i=n===i?.5:i,a=n===a?1:a,l=y.doCannyPruning=n===l?!0:l,g=y.maxScale=m(p/v,I/x),f=y.scale=e,y.min_neighbors=a,y.scale_inc=t,y.increment=i,y.Ready=!1;var T=y.Parallel;if(T&&T.isSupported()){var _,P=[],M=0;for(_=e;g>=_;_*=t)P.push({haardata:w,width:p,height:I,scaledSelection:{x:c.x,y:c.y,width:c.width,height:c.height},integral:C,squares:A,tilted:H,doCannyPruning:l,canny:l?R:null,cannyLow:b,cannyHigh:D,maxScale:g,min_neighbors:a,scale_inc:t,increment:i,scale:_,i:M++});new T(P,{synchronous:!1}).require(r,o,h).map(o).reduce(h).then(function(e){u(y,e)})}else{var L=[],j=function(){y.scale<=y.maxScale?(L=L.concat(o(y)),y.scale*=y.scale_inc,y.TimeInterval=setTimeout(j,y.DetectInterval)):(clearTimeout(y.TimeInterval),u(y,L))};y.TimeInterval=setTimeout(j,y.DetectInterval)}return y}},c[f].selection=c[f].select,d=g.Feature=function(e,n,t,i,a){this.data(e,n,t,i,a)},d[f]={constructor:d,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(e,n,t,i,a){var l=this;return e&&e instanceof d?l.copy(e):e&&e instanceof Object?(l.x=e.x||0,l.y=e.y||0,l.width=e.width||0,l.height=e.height||0,l.index=e.index||0,l.area=e.area||0,l.isInside=e.isInside||!1):(l.x=e||0,l.y=n||0,l.width=t||0,l.height=i||0,l.index=a||0,l.area=0,l.isInside=!1),l},add:function(e){var n=this;return n.x+=e.x,n.y+=e.y,n.width+=e.width,n.height+=e.height,n},scale:function(e){var n=this;return n.x*=e,n.y*=e,n.width*=e,n.height*=e,n},round:function(){var e=this;return e.x=~~(e.x+.5),e.y=~~(e.y+.5),e.width=~~(e.width+.5),e.height=~~(e.height+.5),e},computeArea:function(){var e=this;return e.area=e.width*e.height,e.area},inside:function(e){var n=this;return!!(n.x>=e.x&&n.y>=e.y&&n.x+n.width<=e.x+e.width&&n.y+n.height<=e.y+e.height)},contains:function(e){return e.inside(this)},equal:function(e){var n=this;return!(e.x!==n.x||e.y!==n.y||e.width!==n.width||e.height!==n.height)},almostEqual:function(e){var n=this,t=.2*x(e.width,n.width),i=.2*x(e.height,n.height);return!!(v(n.x-e.x)<=t&&v(n.y-e.y)<=i&&v(n.width-e.width)<=t&&v(n.height-e.height)<=i)},clone:function(){var e=this,n=new d;return n.x=e.x,n.y=e.y,n.width=e.width,n.height=e.height,n.index=e.index,n.area=e.area,n.isInside=e.isInside,n},copy:function(e){var n=this;return e&&e instanceof d&&(n.x=e.x,n.y=e.y,n.width=e.width,n.height=e.height,n.index=e.index,n.area=e.area,n.isInside=e.isInside),n},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}}}(e),e.HAAR});