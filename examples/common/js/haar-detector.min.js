/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.6
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,i,e,n,h){e=e?[].concat(e):[];var a,s,r=Array,l=r.prototype,o=e.length,u=new r(o);if("object"==typeof module&&module.exports){if(h===module.exports[i]){for(a=0;o>a;a++)u[a]=module.exports[e[a][0]]||require(e[a][1])[e[a][0]];s=n.apply(t,u),module.exports[i]=s||1}}else if("function"==typeof define&&define.amd)define(["exports"].concat(e.map(function(t){return t[1]})),function(a){if(h===a[i]){var r,o=l.slice.call(arguments,1),c=o.length;for(r=0;c>r;r++)u[r]=a[e[r][0]]||o[r];s=n.apply(t,u),a[i]=s||1}});else if(h===t[i]){for(a=0;o>a;a++)u[a]=t[e[a][0]];s=n.apply(t,u),t[i]=s||1}}(this,"HAAR",null,function(){var t={};return function(t,i){function e(t,i,e){var n,h,a,s,r,l,o,u=t.length,c=i*e,d=new y(c),f=new g(c),w=new g(c),x=new g(c);for(s=0,a=0,n=h=0;i>s;)o=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,o&=255,n+=o,h+=o*o,d[s]=o,f[s]=n,w[s]=h,x[s]=o,s++,a+=4;for(r=0,l=1,s=i,a=i<<2,n=h=0;u>a;)o=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,o&=255,n+=o,h+=o*o,d[s]=o,f[s]=f[s-i]+n,w[s]=w[s-i]+h,x[s]=x[s+1-i]+(o+d[s-i])+(l>1?x[s-i-i]:0)+(r>0?x[s-1-i]:0),r++,s++,a+=4,r>=i&&(r=0,l++,n=h=0);return{gray:d,integral:f,squares:w,tilted:x}}function n(t,i,e){var n,h,a,s,r,l,o,u,c,d,f,x=t.length,m=new y(x),p=new g(x);for(n=0;i>n;n++)m[n]=0,m[n+i]=0,m[n+x-i]=0,m[n+x-i-i]=0,p[n]=0,p[n+x-i]=0;for(h=0,a=0;e>h;h++,a+=i)m[0+a]=0,m[1+a]=0,m[i-1+a]=0,m[i-2+a]=0,p[0+a]=0,p[i-1+a]=0;for(n=2;i-2>n;n++)for(s=0,h=2,a=i<<1;e-2>h;h++,a+=i)o=n+a,u=o+i,c=u+i,d=o-i,f=d-i,s=0+(t[f-2]<<1)+(t[d-2]<<2)+(t[o-2]<<2)+t[o-2]+(t[u-2]<<2)+(t[c-2]<<1)+(t[f-1]<<2)+(t[d-1]<<3)+t[d-1]+(t[o-1]<<4)-(t[o-1]<<2)+(t[u-1]<<3)+t[u-1]+(t[c-1]<<2)+(t[f]<<2)+t[f]+(t[d]<<4)-(t[d]<<2)+(t[o]<<4)-t[o]+(t[u]<<4)-(t[u]<<2)+(t[c]<<2)+t[c]+(t[f+1]<<2)+(t[d+1]<<3)+t[d+1]+(t[o+1]<<4)-(t[o+1]<<2)+(t[u+1]<<3)+t[u+1]+(t[c+1]<<2)+(t[f+2]<<1)+(t[d+2]<<2)+(t[o+2]<<2)+t[o+2]+(t[u+2]<<2)+(t[c+2]<<1),m[o]=(255&(4294967295&103*s+8192)>>>14)>>>0;for(n=1;i-1>n;n++)for(h=1,a=i;e-1>h;h++,a+=i)o=a+n,u=o+i,d=o-i,r=0-m[d-1]+m[d+1]-m[o-1]-m[o-1]+m[o+1]+m[o+1]-m[u-1]+m[u+1],l=0+m[d-1]+m[d]+m[d]+m[d+1]-m[u-1]-m[u]-m[u]-m[u+1],p[o]=w(r)+w(l);for(n=0,s=0;i>n;)s+=p[n],p[n]=s,n++;for(n=i,a=0,s=0;x>n;)s+=p[n],p[n]=p[n-i]+s,n++,a++,a>=i&&(a=0,s=0);return p}function h(t,i,e){var n,h,s,r,l,o,u,c=t.length,f=new Array(c),g=[],y=0,w=!1;for(s=0;c>s;s++)f[s]=0;for(s=0;c>s;s++){for(w=!1,r=0;s>r;r++)t[r].almostEqual(t[s])&&(w=!0,f[s]=f[r]);w||(f[s]=y,y++)}for(n=new Array(y),h=new Array(y),s=0;y>s;s++)n[s]=0,h[s]=new d;for(s=0;c>s;s++)u=f[s],n[u]++,h[u].add(t[s]);for(s=0;y>s;s++)l=n[s],l>=i&&(o=1/(l+l),u=new d(o*(2*h[s].x+l),o*(2*h[s].y+l),o*(2*h[s].width+l),o*(2*h[s].height+l)),g.push(u));for(1!=e&&(e=1/e),c=g.length,s=0;c>s;s++)for(r=s+1;c>r;r++)!g[s].isInside&&g[s].inside(g[r])?g[s].isInside=!0:!g[r].isInside&&g[r].inside(g[s])&&(g[r].isInside=!0);for(s=c;--s>=0;)g[s].isInside?g.splice(s,1):(1!=e&&g[s].scale(e),g[s].round().computeArea());return g.sort(a)}function a(t,i){return t.area-i.area}function r(t,i){return t.index-i.index}function l(t){return t[1].length&&(t[0]=t[0].concat(t[1]).sort(r)),t[0]}function o(t){var i,e,n,h,a,r,l,o,u,c,d,f,g,y,w,x,m,p,v,I,S,A,C,q,H,R,b,_,T,M,P,L,D,j,E,z,W,k,F,V,O,U,N,B,G,J,K,Q,X,Y=Y||Math.sqrt,Z=[],$=t.haardata,ti=t.scaledSelection,ii=ti.width,ei=ti.height,ni=ii*ei,hi=ni-1,ai=$.size1,si=$.size2,ri=ti.x,li=ti.y,oi=$.stages.length,ui=t.cannyLow,ci=t.cannyHigh,di=t.canny,fi=t.integral,gi=t.squares,yi=t.tilted,wi=t.scale,xi=t.increment,mi=t.i||0,pi=t.doCannyPruning;for(w=0,x=ii-1,m=0,p=ni-ii,n=~~(wi*ai),i=~~(n*xi),h=~~(wi*si),e=~~(h*xi),u=h*ii,c=e*ii,a=li*c,xl=ii-n,yl=ei-h,v=n*h,I=1/v,l=li,o=a;yl>l;l+=e,o+=c)for(r=ri;xl>r;r+=i)if(d=r-1+o-ii,f=d+n,g=d+u,y=g+n,d=0>d?0:d>hi?hi:d,f=0>f?0:f>hi?hi:f,g=0>g?0:g>hi?hi:g,y=0>y?0:y>hi?hi:y,!(pi&&(q=I*(di[y]-di[g]-di[f]+di[d]),ui>q||q>ci))){for(S=I*(fi[y]-fi[g]-fi[f]+fi[d]),A=I*(gi[y]-gi[g]-gi[f]+gi[d]),C=A-S*S,C=C>1?Y(C):1,H=!0,s=0;oi>s;s++){for(R=$.stages[s],b=R.thres,_=R.trees,T=_.length,X=0,M=0;T>M;M++)for(D=_[M].feats,P=0;;){if(j=D[P],E=j.rects,z=E.length,W=j.thres,k=0,j.tilt)for(F=0;z>F;F++)V=E[F],O=r+~~(wi*V[0]),U=(l-1+~~(wi*V[1]))*ii,N=r+~~(wi*(V[0]+V[2])),B=(l-1+~~(wi*(V[1]+V[2])))*ii,G=r+~~(wi*(V[0]-V[3])),J=(l-1+~~(wi*(V[1]+V[3])))*ii,K=r+~~(wi*(V[0]+V[2]-V[3])),Q=(l-1+~~(wi*(V[1]+V[2]+V[3])))*ii,O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,G=w>G?w:G>x?x:G,K=w>K?w:K>x?x:K,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,J=m>J?m:J>p?p:J,Q=m>Q?m:Q>p?p:Q,k+=V[4]*(yi[K+Q]-yi[G+J]-yi[N+B]+yi[O+U]);else for(F=0;z>F;F++)V=E[F],O=r-1+~~(wi*V[0]),N=r-1+~~(wi*(V[0]+V[2])),U=ii*(l-1+~~(wi*V[1])),B=ii*(l-1+~~(wi*(V[1]+V[3]))),O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,k+=V[4]*(fi[N+B]-fi[O+B]-fi[N+U]+fi[O+U]);if(L=W*C>k*I?0:1){if(j.has_r){X+=j.r_val;break}P=j.r_node}else{if(j.has_l){X+=j.l_val;break}P=j.l_node}}if(H=X>b?!0:!1,!H)break}H&&Z.push({index:mi,x:r,y:l,width:n,height:h})}return Z}function u(t,i){for(var e=0,n=i.length;n>e;e++)i[e]=new d(i[e]);t.objects=h(i,t.min_neighbors,t.Ratio,t.Selection),t.Ready=!0,t.onComplete&&t.onComplete.call(t)}var c,d,f={VERSION:"0.4.6"},g="undefined"!=typeof Float32Array?Float32Array:Array,y="undefined"!=typeof Uint8Array?Uint8Array:Array,w=Math.abs,x=Math.max,m=Math.min,p=(Math.floor,Math.round),v=(Math.sqrt,Array.prototype.slice);c=f.Detector=function(t,i){this.haardata=t||null,this.Ready=!1,this.doCannyPruning=!1,this.Canvas=null,this.Selection=null,this.scaledSelection=null,this.objects=null,this.TimeInterval=null,this.DetectInterval=30,this.Ratio=.5,this.cannyLow=20,this.cannyHigh=100,this.Parallel=i||null,this.onComplete=null},c.prototype={constructor:c,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,clearCache:function(){return this.haardata=null,this.canny=null,this.integral=null,this.squares=null,this.tilted=null,this.Selection=null,this.scaledSelection=null,this},cascade:function(t){return this.haardata=t||null,this},parallel:function(t){return this.Parallel=t||null,this},image:function(t,h,a){if(t){var s,r,l,o,u,c,d,f,g;this.Canvas||(this.Canvas=a||document.createElement("canvas")),g=this.Canvas,f=this.Ratio=i===h?.5:h,this.Ready=!1,o=this.origWidth=t instanceof HTMLVideoElement?t.videoWidth:t.width,u=this.origHeight=t instanceof HTMLVideoElement?t.videoHeight:t.height,c=this.width=g.width=p(f*o),d=this.height=g.height=p(f*u),s=g.getContext("2d"),s.drawImage(t,0,0,o,u,0,0,c,d),r=s.getImageData(0,0,c,d),l=e(r.data,r.width,r.height),this.integral=l.integral,this.squares=l.squares,this.tilted=l.tilted,this.canny=n(l.gray,c,d),l.gray=null,l.integral=null,l.squares=null,l.tilted=null,l=null}return this},interval:function(t){return t>0&&(this.DetectInterval=t),this},cannyThreshold:function(t){return t&&i!==t.low&&(this.cannyLow=t.low),t&&i!==t.high&&(this.cannyHigh=t.high),this},selection:function(){var t=v.call(arguments),i=t.length;return this.Selection=1==i&&"auto"==t[0]||!i?null:d.prototype.data.apply(new d,t),this},complete:function(t){return this.onComplete=t||null,this},detect:function(t,e,n,h,a){var s,c,f,g,y=this,w=y.haardata,x=w.size1,p=w.size2,v=y.width,I=y.height,S=y.origWidth,A=y.origHeight,C=y.integral,q=y.squares,H=y.tilted,R=y.canny,b=y.cannyLow,_=y.cannyHigh;y.Selection||(y.Selection=new d(0,0,S,A)),s=y.Selection,s.x="auto"==s.x?0:s.x,s.y="auto"==s.y?0:s.y,s.width="auto"==s.width?S:s.width,s.height="auto"==s.height?A:s.height,c=y.scaledSelection=s.clone().scale(y.Ratio).round(),t=i===t?1:t,e=i===e?1.25:e,n=i===n?.5:n,h=i===h?1:h,a=y.doCannyPruning=i===a?!0:a,f=y.maxScale=m(v/x,I/p),g=y.scale=t,y.min_neighbors=h,y.scale_inc=e,y.increment=n,y.Ready=!1;var T=y.Parallel;if(T&&T.isSupported()){var M,P=[],L=0;for(M=t;f>=M;M*=e)P.push({haardata:w,width:v,height:I,scaledSelection:{x:c.x,y:c.y,width:c.width,height:c.height},integral:C,squares:q,tilted:H,doCannyPruning:a,canny:a?R:null,cannyLow:b,cannyHigh:_,maxScale:f,min_neighbors:h,scale_inc:e,increment:n,scale:M,i:L++});new T(P,{synchronous:!1}).require(r,o,l).map(o).reduce(l).then(function(t){u(y,t)})}else{var D=[],j=function(){y.scale<=y.maxScale?(D=D.concat(o(y)),y.scale*=y.scale_inc,y.TimeInterval=setTimeout(j,y.DetectInterval)):(clearTimeout(y.TimeInterval),u(y,D))};y.TimeInterval=setTimeout(j,y.DetectInterval)}return this}},d=f.Feature=function(t,i,e,n,h){this.data(t,i,e,n,h)},d.prototype={constructor:d,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(t,i,e,n,h){return t&&t instanceof d?this.copy(t):t&&t instanceof Object?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.index=t.index||0,this.area=t.area||0,this.isInside=t.isInside||!1):(this.x=t||0,this.y=i||0,this.width=e||0,this.height=n||0,this.index=h||0,this.area=0,this.isInside=!1),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},scale:function(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this},round:function(){return this.x=~~(this.x+.5),this.y=~~(this.y+.5),this.width=~~(this.width+.5),this.height=~~(this.height+.5),this},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(t){return this.x>=t.x&&this.y>=t.y&&this.x+this.width<=t.x+t.width&&this.y+this.height<=t.y+t.height?!0:!1},contains:function(t){return t.inside(this)},equal:function(t){return t.x==this.x&&t.y==this.y&&t.width==this.width&&t.height==this.height?!0:!1},almostEqual:function(t){var i=.2*x(t.width,this.width),e=.2*x(t.height,this.height);return w(this.x-t.x)<=i&&w(this.y-t.y)<=e&&w(this.width-t.width)<=i&&w(this.height-t.height)<=e?!0:!1},clone:function(){var t=new d;return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.index=this.index,t.area=this.area,t.isInside=this.isInside,t},copy:function(t){return t&&t instanceof d&&(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.index=t.index,this.area=t.area,this.isInside=t.isInside),this},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}},t.HAAR=f}(t),t.HAAR});