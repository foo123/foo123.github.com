/**
*
* Color Picker jQueryUI ModelView Widget
*
* @url: https://github.com/foo123/modelview-widgets
* @dependencies: jQuery, jQueryUI (widget), ModelViewWidget
*
* adapted from: http://www.eyecon.ro/colorpicker/
*      Color Picker by Stefan Petre www.eyecon.ro (MIT and GPL)
*
*/
!function(e,t){function o(){var e="CSS1Compat"==document.compatMode;return{l:window.pageXOffset||(e?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(e?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(e?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(e?document.documentElement.clientHeight:document.body.clientHeight)}}function i(e,t,o){if(e===t)return!0;if(e.contains)return e.contains(t);if(e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));for(var i=t.parentNode;i&&i!==o;){if(i===e)return!0;i=i.parentNode}return!1}function n(e){return[w(0,g(360,e[0])),w(0,g(100,e[1])),w(0,g(100,e[2]))]}function r(e){return[w(0,g(255,e[0])),w(0,g(255,e[1])),w(0,g(255,e[2]))]}function s(e){e="#"===e.charAt(0)?e.slice(1):e;var t=6-e.length;return t>0&&(e=new Array(t+1).join("0")+e),e}function a(e){return e=parseInt(e,16),[e>>16&255,e>>8&255,255&e]}function c(e){var t=0,o=0,i=0,n=e[0],r=e[1],s=e[2],a=g(n,r,s),c=w(n,r,s),l=c-a;return i=c,o=0!=c?255*l/c:0,t=0!=o?n===c?(r-s)/l:r===c?2+(s-n)/l:4+(n-r)/l:-1,t*=60,0>t&&(t+=360),o*=100/255,i*=100/255,[y(t),y(o),y(i)]}function l(e){var t,o,i,n=y(e[0]),r=y(255*e[1]/100),s=y(255*e[2]/100);if(0===r)t=o=i=s;else{var a=s,c=(255-r)*s/255,l=(a-c)*(n%60)/60;360==n&&(n=0),60>n?(t=a,i=c,o=c+l):120>n?(o=a,i=c,t=a-l):180>n?(o=a,t=c,i=c+l):240>n?(i=a,t=c,o=a-l):300>n?(i=a,o=c,t=c+l):360>n?(t=a,o=c,i=a-l):(t=0,o=0,i=0)}return[y(t),y(o),y(i)]}function d(e){var t=[e[0].toString(16),e[1].toString(16),e[2].toString(16)];return 1===t[0].length&&(t[0]="0"+t[0]),1===t[1].length&&(t[1]="0"+t[1]),1===t[2].length&&(t[2]="0"+t[2]),t.join("")}function u(e){return parseInt(e,10)}function p(e){return e.slice(4,-1).split($).map(u)}function b(e){return e.slice(4,-1).split($).map(u)}function f(e){return e=e.slice(5,-1).split($),[e.slice(0,3).map(u),e[3]]}function h(e,t,o){return'        <div id="'+e+'" class="ui-colorpicker">        <button class="ui-colorpicker_satur_bright" '+o+'=\'{"mousedown":"downSelector"}\'><div></div></button>        <button class="ui-colorpicker_hue" '+o+'=\'{"mousedown":"downHue"}\'><div></div></button>        <div class="ui-colorpicker_new_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+t+'.css.color.current);" '+o+'=\'{"click":"setColor"}\'></button>        </div>        <div class="ui-colorpicker_current_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+t+'.css.color);" '+o+'=\'{"click":"restoreColor"}\'></button>        </div>        <div class="ui-colorpicker_field" data-field="hex">        <input name="'+t+'[hex]" type="text" maxlength="6" size="6" value=""/>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.0">        <input name="'+t+'[rgb][0]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.1">        <input name="'+t+'[rgb][1]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.2">        <input name="'+t+'[rgb][2]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.0">        <input name="'+t+'[hsb][0]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.1">        <input name="'+t+'[hsb][1]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.2">        <input name="'+t+'[hsb][2]" type="text" maxlength="3" size="3" value=""/><span '+o+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <button class="ui-colorpicker_submit" '+o+'=\'{"click":"setColor"}\'></button>        </div>        '}function m(){}function v(e){return k({eventName:"click",onShow:m,onBeforeShow:m,onHide:m,onSetColor:m,color:"ff0000",opacity:1,livePreview:!0},e||{})}var g=Math.min,w=Math.max,y=Math.round,k=e.extend,$=/\s*,\s*/g,_=0;e.widget("mvc.ColorPicker",e.mvc.ModelViewWidget,{options:{},$view:null,_create:function(){var u,m,y,k,$,C,x,T,M,I,A,V,S,P,E,j,H,L,N=this,Y=N.element,z=0,F=0,R=0;V=N,N.options=v(N.options),S=function(e){return N.$view.$model.set(e.data.type,w(0,g(e.data.max,parseInt(e.data.val+e.pageY-e.data.y,10)))),V.options.livePreview&&N.$view.$model.set(e.data.key,N.$view.$model.get(e.data.key,1),1),!1},P=function(t){return e(document).unbind("mouseup",P).unbind("mousemove",S),z=0,t.data.el.removeClass("ui-colorpicker_slider").find("input").focus(),N.$view.$model.set(t.data.key,N.$view.$model.get(t.data.key,1),1),!1},E=function(e){if(V.options.livePreview){var t=N.$view.$model.$data.hsb;N.$view.$model.set("hsb",[parseInt(360*(148-w(0,g(148,e.pageY-e.data.y)))/148,10),t[1],t[2]],1)}return!1},j=function(t){e(document).unbind("mouseup",j).unbind("mousemove",E),F=0;var o=N.$view.$model.$data.hsb;return N.$view.$model.set("hsb",[parseInt(360*(148-w(0,g(148,t.pageY-t.data.y)))/148,10),o[1],o[2]],1),!1},H=function(e){if(V.options.livePreview){var t=N.$view.$model.$data.hsb;N.$view.$model.set("hsb",[t[0],parseInt(100*w(0,g(150,e.pageX-e.data.pos.left))/150,10),parseInt(100*(150-w(0,g(150,e.pageY-e.data.pos.top)))/150,10)],1)}return!1},L=function(t){e(document).unbind("mouseup",L).unbind("mousemove",H),R=0;var o=N.$view.$model.$data.hsb;return N.$view.$model.set("hsb",[o[0],parseInt(100*w(0,g(150,t.pageX-t.data.pos.left))/150,10),parseInt(100*(150-w(0,g(150,t.pageY-t.data.pos.top)))/150,10)],1),!1},$=e(h(m="clrpkrui"+ ++_,y="model_"+m,k="data-bind-"+m)),T=$.find(".ui-colorpicker_hue div")[0],C=$.find(".ui-colorpicker_satur_bright")[0],x=$.find(".ui-colorpicker_satur_bright div")[0],N.$view=$.modelview({id:m,autoSync:!1,bindAttribute:k,livebind:"$(__MODEL__.__KEY__)",autobind:!0,bindbubble:!0,events:["change","blur","focus","mousedown","click"],model:{id:y,data:{opacity:1,hsb:[0,0,0],rgb:[0,0,0],hex:"000000"},types:{opacity:e.ModelView.Type.Cast.CLAMP(0,1).AFTER(e.ModelView.Type.Cast.FLOAT),"hsb.0":e.ModelView.Type.Cast.CLAMP(0,360).AFTER(e.ModelView.Type.Cast.INT),"hsb.1":e.ModelView.Type.Cast.CLAMP(0,100).AFTER(e.ModelView.Type.Cast.INT),"hsb.2":e.ModelView.Type.Cast.CLAMP(0,100).AFTER(e.ModelView.Type.Cast.INT),"rgb.*":e.ModelView.Type.Cast.CLAMP(0,255).AFTER(e.ModelView.Type.Cast.INT),hex:e.ModelView.Type.Cast.TRIM},validators:{hex:e.ModelView.Validation.Validate.MATCH(/^[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]$/i)},getters:{color:function(){return this.$data.rgb},"css.color":function(){return"rgba("+u.join(",")+","+this.$data.opacity+")"},"css.color.current":function(){return"rgba("+this.$data.rgb.join(",")+","+this.$data.opacity+")"},"css.color.rgb":function(){return"rgb("+this.$data.rgb.join(",")+")"},"css.color.hsl":function(){var e=this.$data.hsb;return"hsl("+[e[0],e[1]+"%",e[2]+"%"].join(",")+")"},"css.color.hex":function(){return"#"+this.$data.hex}},setters:{opacity:function(e,t,o){var i=this;return i.$data.opacity=t,o&&(i.notify("css.color"),V.element[0].style.backgroundColor=i.get("css.color")),!0},"css.color":function(e,t,o){var i,n,r=this;return t&&t.substring&&(i=t.slice(0,4),"rgba"===i?(n=f(t),r.set("opacity",n[1]).set("rgb",n[0])):"rgb("===i?(n=b(t),r.set("rgb",n)):"hsl("===i?(n=p(t),r.set("hsb",n)):(n=t,r.set("hex","#"===n.charAt(0)?n.slice(1):n)),u=r.$data.rgb.slice(),o&&(r.notify(["hsb","rgb","hex","color"]),V.element[0].style.backgroundColor=r.get("css.color"))),!0},color:function(e,o,i){var n=this;return o&&(o.substring?n.set("hex","#"===o.charAt(0)?o.slice(1):o):o.h!==t&&o.s!==t&&o.b!==t?n.set("hsb",[o.h,o.s,o.b]):o.r!==t&&o.g!==t&&o.b!==t?n.set("rgb",[o.r,o.g,o.b]):n.set("rgb",[o[0]||0,o[1]||0,o[2]||0]),u=n.$data.rgb.slice(),i&&(n.notify(["hsb","rgb","hex","css.color"]),V.element[0].style.backgroundColor=n.get("css.color"))),!0},hsb:function(e,t,o){var i,r=this,s=r.$data;return i=s.hsb=n(t),s.rgb=l(i),s.hex=d(s.rgb),C.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",x.style.top=150*(100-i[2])/100+"px",x.style.left=150*i[1]/100+"px",T.style.top=148-148*i[0]/360+"px",o&&r.notify(["rgb","hex","css.color.current"]),!0},"hsb.*":function(e,t,o){return this.$data.hsb[parseInt(e.slice(4),10)]=t,o&&this.set("hsb",this.$data.hsb,o),!1},rgb:function(e,t,o){var i,n=this,s=n.$data;return s.rgb=r(t),s.hex=d(s.rgb),i=s.hsb=c(s.rgb),C.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",x.style.top=150*(100-i[2])/100+"px",x.style.left=150*i[1]/100+"px",T.style.top=148-148*i[0]/360+"px",o&&n.notify(["hsb","hex","css.color.current"]),!0},"rgb.*":function(e,t,o){return this.$data.rgb[parseInt(e.slice(4),10)]=t,o&&this.set("rgb",this.$data.rgb,o),!1},hex:function(e,t,o){var i,n=this,r=n.$data;return r.hex=s(t),r.rgb=a(r.hex),i=r.hsb=c(r.rgb),C.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",x.style.top=150*(100-i[2])/100+"px",x.style.left=150*i[1]/100+"px",T.style.top=148-148*i[0]/360+"px",o&&n.notify(["hsb","rgb","css.color.current"]),!0}}},actions:{setColor:function(){this.$model.set("color",this.$model.$data.rgb,1),I&&I(!0),V.options.onSetColor(V.element)},restoreColor:function(){this.$model.set("color",u,1)},downIncrement:function(t,o){if(!z){var i=e(o.parentNode).addClass("ui-colorpicker_slider"),n=i.attr("data-field"),r=i.find("input").focus(),s={el:i,type:n,key:n.slice(0,3),max:"hsb.0"===n?360:0===n.indexOf("hsb")?100:255,y:t.pageY,field:r,val:parseInt(r.val(),10)};z=1,e(document).bind("mouseup",s,P).bind("mousemove",s,S)}},downHue:function(t,o){if(!F){var i={y:e(o).offset().top};F=1,e(document).bind("mouseup",i,j).bind("mousemove",i,E)}},downSelector:function(t,o){if(!R){var i={pos:e(o).offset()};R=1,e(document).bind("mouseup",i,L).bind("mousemove",i,H)}}}}).modelview("view"),N.$view.$model.set("opacity",V.options.opacity).set("color",V.options.color),Y.hasClass("ui-colorpicker-flat")?$.addClass("ui-colorpicker-flat").appendTo(Y).show():(A=function(e){27===e.keyCode&&I(!0)},I=function O(t){$.hasClass("ui-colorpicker-visible")&&(!0===t||t.target!==Y[0]&&!i($[0],t.target,$[0]))&&(!1!==V.options.onHide($)&&$.removeClass("ui-colorpicker-visible"),e(document).unbind("keyup",A).unbind("mousedown",O))},M=function(){if(!$.hasClass("ui-colorpicker-visible")){V.options.onBeforeShow($);var t=e(this).offset(),i=o(),n=t.top+this.offsetHeight,r=t.left;n+176>i.t+i.h&&(n-=this.offsetHeight+176),r+356>i.l+i.w&&(r-=356),$.css({left:r+"px",top:n+"px"}),!1!==V.options.onShow($)&&$.addClass("ui-colorpicker-visible"),e(document).bind("keyup",A).bind("mousedown",I)}return!1},$.appendTo(document.body),Y.bind(N.options.eventName,M)),N.$view.sync(),Y.addClass("ui-colorselector").css("background-color",N.$view.$model.get("css.color")),Y.hasClass("ui-colorpicker-light")&&$.addClass("ui-colorpicker-light"),Y.hasClass("ui-colorpicker-transition-fade")&&$.addClass("ui-colorpicker-transition-fade"),Y.hasClass("ui-colorpicker-transition-slide")&&$.addClass("ui-colorpicker-transition-slide")},color:function(e){var t=this,o=arguments.length;return o?(t.$view.$model.set("color",e,1),t.element):t.$view.$model.get("css.color")},opacity:function(e){var t=this,o=arguments.length;return o?(t.$view.$model.set("opacity",e,1),t.element):t.$view.$model.get("opacity")}})}(jQuery);
