/**
*
* Color Picker jQueryUI ModelView Widget
*
* @url: https://github.com/foo123/modelview-widgets
* @dependencies: jQuery, jQueryUI (widget), ModelViewWidget
*
* adapted from: http://www.eyecon.ro/colorpicker/
*      Color Picker by Stefan Petre www.eyecon.ro (MIT and GPL)
*
*/
!function(e,o){function t(){var e="CSS1Compat"==document.compatMode;return{l:window.pageXOffset||(e?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(e?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(e?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(e?document.documentElement.clientHeight:document.body.clientHeight)}}function i(e,o,t){if(e===o)return!0;if(e.contains)return e.contains(o);if(e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(o));for(var i=o.parentNode;i&&i!==t;){if(i===e)return!0;i=i.parentNode}return!1}function n(e){return[h(0,f(360,e[0])),h(0,f(100,e[1])),h(0,f(100,e[2]))]}function r(e){return[h(0,f(255,e[0])),h(0,f(255,e[1])),h(0,f(255,e[2]))]}function s(e){e="#"===e.charAt(0)?e.slice(1):e;var o=6-e.length;return o>0&&(e=new Array(o+1).join("0")+e),e}function a(e){return e=parseInt(e,16),[e>>16&255,e>>8&255,255&e]}function c(e){var o=0,t=0,i=0,n=e[0],r=e[1],s=e[2],a=f(n,r,s),c=h(n,r,s),l=c-a;return i=c,t=0!=c?255*l/c:0,o=0!=t?n===c?(r-s)/l:r===c?2+(s-n)/l:4+(n-r)/l:-1,o*=60,0>o&&(o+=360),t*=100/255,i*=100/255,[v(o),v(t),v(i)]}function l(e){var o,t,i,n=v(e[0]),r=v(255*e[1]/100),s=v(255*e[2]/100);if(0===r)o=t=i=s;else{var a=s,c=(255-r)*s/255,l=(a-c)*(n%60)/60;360==n&&(n=0),60>n?(o=a,i=c,t=c+l):120>n?(t=a,i=c,o=a-l):180>n?(t=a,o=c,i=c+l):240>n?(i=a,o=c,t=a-l):300>n?(i=a,t=c,o=c+l):360>n?(o=a,t=c,i=a-l):(o=0,t=0,i=0)}return[v(o),v(t),v(i)]}function d(e){var o=[e[0].toString(16),e[1].toString(16),e[2].toString(16)];return 1===o[0].length&&(o[0]="0"+o[0]),1===o[1].length&&(o[1]="0"+o[1]),1===o[2].length&&(o[2]="0"+o[2]),o.join("")}function u(e,o,t){return'        <div id="'+e+'" class="ui-colorpicker">        <button class="ui-colorpicker_satur_bright" '+t+'=\'{"mousedown":"downSelector"}\'><div></div></button>        <button class="ui-colorpicker_hue" '+t+'=\'{"mousedown":"downHue"}\'><div></div></button>        <div class="ui-colorpicker_new_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+o+'.css.color.current);" '+t+'=\'{"click":"setColor"}\'></button>        </div>        <div class="ui-colorpicker_current_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+o+'.css.color);" '+t+'=\'{"click":"restoreColor"}\'></button>        </div>        <div class="ui-colorpicker_field" data-field="hex">        <input name="'+o+'[hex]" type="text" maxlength="6" size="6" value=""/>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.0">        <input name="'+o+'[rgb][0]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.1">        <input name="'+o+'[rgb][1]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.2">        <input name="'+o+'[rgb][2]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.0">        <input name="'+o+'[hsb][0]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.1">        <input name="'+o+'[hsb][1]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.2">        <input name="'+o+'[hsb][2]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <button class="ui-colorpicker_submit" '+t+'=\'{"click":"setColor"}\'></button>        </div>        '}function p(){}function b(e){return m({eventName:"click",onShow:p,onBeforeShow:p,onHide:p,onSetColor:p,color:"ff0000",opacity:1,livePreview:!0},e||{})}var f=Math.min,h=Math.max,v=Math.round,m=e.extend,g=0;e.widget("mvc.ColorPicker",e.mvc.ModelViewWidget,{options:{},$view:null,_create:function(){var p,v,m,w,y,k,$,_,C,x,T,M,I,A,V,S,P,E,j=this,H=j.element,L=0,N=0,Y=0;M=j,j.options=b(j.options),I=function(e){return j.$view.$model.set(e.data.type,h(0,f(e.data.max,parseInt(e.data.val+e.pageY-e.data.y,10)))),M.options.livePreview&&j.$view.$model.set(e.data.key,j.$view.$model.get(e.data.key,1),1),!1},A=function(o){return e(document).unbind("mouseup",A).unbind("mousemove",I),L=0,o.data.el.removeClass("ui-colorpicker_slider").find("input").focus(),j.$view.$model.set(o.data.key,j.$view.$model.get(o.data.key,1),1),!1},V=function(e){if(M.options.livePreview){var o=j.$view.$model.$data.hsb;j.$view.$model.set("hsb",[parseInt(360*(148-h(0,f(148,e.pageY-e.data.y)))/148,10),o[1],o[2]],1)}return!1},S=function(o){e(document).unbind("mouseup",S).unbind("mousemove",V),N=0;var t=j.$view.$model.$data.hsb;return j.$view.$model.set("hsb",[parseInt(360*(148-h(0,f(148,o.pageY-o.data.y)))/148,10),t[1],t[2]],1),!1},P=function(e){if(M.options.livePreview){var o=j.$view.$model.$data.hsb;j.$view.$model.set("hsb",[o[0],parseInt(100*h(0,f(150,e.pageX-e.data.pos.left))/150,10),parseInt(100*(150-h(0,f(150,e.pageY-e.data.pos.top)))/150,10)],1)}return!1},E=function(o){e(document).unbind("mouseup",E).unbind("mousemove",P),Y=0;var t=j.$view.$model.$data.hsb;return j.$view.$model.set("hsb",[t[0],parseInt(100*h(0,f(150,o.pageX-o.data.pos.left))/150,10),parseInt(100*(150-h(0,f(150,o.pageY-o.data.pos.top)))/150,10)],1),!1},y=e(u(v="clrpkrui"+ ++g,m="model_"+v,w="data-bind-"+v)),_=y.find(".ui-colorpicker_hue div")[0],k=y.find(".ui-colorpicker_satur_bright")[0],$=y.find(".ui-colorpicker_satur_bright div")[0],j.$view=y.modelview({id:v,autoSync:!1,bindAttribute:w,livebind:"$(__MODEL__.__KEY__)",autobind:!0,bindbubble:!0,events:["change","blur","focus","mousedown","click"],model:{id:m,data:{opacity:1,hsb:[0,0,0],rgb:[0,0,0],hex:"000000"},types:{opacity:e.ModelView.Type.Cast.CLAMP(0,1).AFTER(e.ModelView.Type.Cast.FLOAT),"hsb.0":e.ModelView.Type.Cast.CLAMP(0,360).AFTER(e.ModelView.Type.Cast.INT),"hsb.1":e.ModelView.Type.Cast.CLAMP(0,100).AFTER(e.ModelView.Type.Cast.INT),"hsb.2":e.ModelView.Type.Cast.CLAMP(0,100).AFTER(e.ModelView.Type.Cast.INT),"rgb.*":e.ModelView.Type.Cast.CLAMP(0,255).AFTER(e.ModelView.Type.Cast.INT),hex:e.ModelView.Type.Cast.TRIM},validators:{hex:e.ModelView.Validation.Validate.MATCH(/^[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]$/i)},getters:{color:function(){return this.$data.rgb},"css.color":function(){return"rgba("+p.join(",")+","+this.$data.opacity+")"},"css.color.current":function(){return"rgba("+this.$data.rgb.join(",")+","+this.$data.opacity+")"},"css.color.rgb":function(){return"rgb("+this.$data.rgb.join(",")+")"},"css.color.hsl":function(){var e=this.$data.hsb;return"hsl("+[e[0],e[1]+"%",e[2]+"%"].join(",")+")"},"css.color.hex":function(){return"#"+this.$data.hex}},setters:{opacity:function(e,o,t){var i=this;return i.$data.opacity=o,t&&(i.notify("css.color"),M.element.css("background-color",i.get("css.color"))),!0},color:function(e,t,i){var n=this;return t&&("string"==typeof t?n.set("hex","#"===t.charAt(0)?t.slice(1):t,i):t.h!==o&&t.s!==o&&t.b!==o?n.set("hsb",[t.h,t.s,t.b],i):t.r!==o&&t.g!==o&&t.b!==o?n.set("rgb",[t.r,t.g,t.b],i):n.set("rgb",[t[0]||0,t[1]||0,t[2]||0],i),p=n.$data.rgb.slice(),i&&(n.notify("css.color"),M.element.css("background-color",n.get("css.color")))),!0},hsb:function(e,o,t){var i,r=this,s=r.$data;return i=s.hsb=n(o),s.rgb=l(i),s.hex=d(s.rgb),k.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",$.style.top=150*(100-i[2])/100+"px",$.style.left=150*i[1]/100+"px",_.style.top=148-148*i[0]/360+"px",t&&r.notify(["rgb","hex","css.color.current"]),!0},"hsb.*":function(e,o,t){return this.$data.hsb[parseInt(e.slice(4),10)]=o,t&&this.set("hsb",this.$data.hsb,t),!1},rgb:function(e,o,t){var i,n=this,s=n.$data;return s.rgb=r(o),s.hex=d(s.rgb),i=s.hsb=c(s.rgb),k.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",$.style.top=150*(100-i[2])/100+"px",$.style.left=150*i[1]/100+"px",_.style.top=148-148*i[0]/360+"px",t&&n.notify(["hsb","hex","css.color.current"]),!0},"rgb.*":function(e,o,t){return this.$data.rgb[parseInt(e.slice(4),10)]=o,t&&this.set("rgb",this.$data.rgb,t),!1},hex:function(e,o,t){var i,n=this,r=n.$data;return r.hex=s(o),r.rgb=a(r.hex),i=r.hsb=c(r.rgb),k.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",$.style.top=150*(100-i[2])/100+"px",$.style.left=150*i[1]/100+"px",_.style.top=148-148*i[0]/360+"px",t&&n.notify(["hsb","rgb","css.color.current"]),!0}}},actions:{setColor:function(){this.$model.set("color",this.$model.$data.rgb,1),x&&x(!0),M.options.onSetColor(M.element)},restoreColor:function(){this.$model.set("color",p,1)},downIncrement:function(o,t){if(!L){var i=e(t.parentNode).addClass("ui-colorpicker_slider"),n=i.attr("data-field"),r=i.find("input").focus(),s={el:i,type:n,key:n.slice(0,3),max:"hsb.0"===n?360:0===n.indexOf("hsb")?100:255,y:o.pageY,field:r,val:parseInt(r.val(),10)};L=1,e(document).bind("mouseup",s,A).bind("mousemove",s,I)}},downHue:function(o,t){if(!N){var i={y:e(t).offset().top};N=1,e(document).bind("mouseup",i,S).bind("mousemove",i,V)}},downSelector:function(o,t){if(!Y){var i={pos:e(t).offset()};Y=1,e(document).bind("mouseup",i,E).bind("mousemove",i,P)}}}}).modelview("view"),j.$view.$model.set("opacity",M.options.opacity).set("color",M.options.color),H.hasClass("ui-colorpicker-flat")?y.addClass("ui-colorpicker-flat").appendTo(H).show():(T=function(e){27===e.keyCode&&x(!0)},x=function z(o){y.hasClass("ui-colorpicker-visible")&&(!0===o||o.target!==H[0]&&!i(y[0],o.target,y[0]))&&(!1!==M.options.onHide(y)&&y.removeClass("ui-colorpicker-visible"),e(document).unbind("keyup",T).unbind("mousedown",z))},C=function(){if(!y.hasClass("ui-colorpicker-visible")){M.options.onBeforeShow(y);var o=e(this).offset(),i=t(),n=o.top+this.offsetHeight,r=o.left;n+176>i.t+i.h&&(n-=this.offsetHeight+176),r+356>i.l+i.w&&(r-=356),y.css({left:r+"px",top:n+"px"}),!1!==M.options.onShow(y)&&y.addClass("ui-colorpicker-visible"),e(document).bind("keyup",T).bind("mousedown",x)}return!1},y.appendTo(document.body),H.bind(j.options.eventName,C)),j.$view.sync(),H.addClass("ui-colorselector").css("background-color",j.$view.$model.get("css.color")),H.hasClass("ui-colorpicker-light")&&y.addClass("ui-colorpicker-light"),H.hasClass("ui-colorpicker-transition-fade")&&y.addClass("ui-colorpicker-transition-fade"),H.hasClass("ui-colorpicker-transition-slide")&&y.addClass("ui-colorpicker-transition-slide")},color:function(e,o){var t=arguments.length;return t?(this.$view.$model.set("color",e,1),t>1&&this.$view.$model.set("opacity",o,1),this.element):this.$view.$model.get("css.color")}})}(jQuery);