/**
*
* Color Picker jQueryUI ModelView Widget
*
* @url: https://github.com/foo123/modelview-widgets
* @dependencies: jQuery, jQueryUI (widget), ModelViewWidget
*
* adapted from: http://www.eyecon.ro/colorpicker/
*      Color Picker by Stefan Petre www.eyecon.ro (MIT and GPL)
*
*/
!function(e,o){"use strict";function t(){var e="CSS1Compat"==document.compatMode;return{l:window.pageXOffset||(e?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(e?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(e?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(e?document.documentElement.clientHeight:document.body.clientHeight)}}function i(e,o,t){if(e===o)return!0;if(e.contains)return e.contains(o);if(e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(o));for(var i=o.parentNode;i&&i!==t;){if(i===e)return!0;i=i.parentNode}return!1}function n(e){return[k(0,g(360,e[0])),k(0,g(100,e[1])),k(0,g(100,e[2]))]}function r(e){return[k(0,g(255,e[0])),k(0,g(255,e[1])),k(0,g(255,e[2]))]}function s(e){e="#"===e.charAt(0)?e.slice(1):e;var o=6-e.length;return o>0&&(e=new Array(o+1).join("0")+e),e}function c(e){return e=parseInt(e,16),[e>>16&255,e>>8&255,255&e]}function a(e){var o=0,t=0,i=0,n=e[0],r=e[1],s=e[2],c=g(n,r,s),a=k(n,r,s),l=a-c;return i=a,t=0!=a?255*l/a:0,o=0!=t?n===a?(r-s)/l:r===a?2+(s-n)/l:4+(n-r)/l:-1,o*=60,0>o&&(o+=360),t*=100/255,i*=100/255,[w(o),w(t),w(i)]}function l(e){var o,t,i,n=w(e[0]),r=w(255*e[1]/100),s=w(255*e[2]/100);if(0===r)o=t=i=s;else{var c=s,a=(255-r)*s/255,l=(c-a)*(n%60)/60;360==n&&(n=0),60>n?(o=c,i=a,t=a+l):120>n?(t=c,i=a,o=c-l):180>n?(t=c,o=a,i=a+l):240>n?(i=c,o=a,t=c-l):300>n?(i=c,t=a,o=a+l):360>n?(o=c,t=a,i=c-l):(o=0,t=0,i=0)}return[w(o),w(t),w(i)]}function d(e){var o=[e[0].toString(16),e[1].toString(16),e[2].toString(16)];return 1===o[0].length&&(o[0]="0"+o[0]),1===o[1].length&&(o[1]="0"+o[1]),1===o[2].length&&(o[2]="0"+o[2]),o.join("")}function u(e){return parseInt(e,10)}function p(e){return e.slice(4,-1).split(y).map(u)}function b(e){return e.slice(4,-1).split(y).map(u)}function f(e){return e=e.slice(5,-1).split(y),[e.slice(0,3).map(u),e[3]]}function h(e,o,t){return'        <div id="'+e+'" class="ui-colorpicker">        <button class="ui-colorpicker_satur_bright" '+t+'=\'{"mousedown":"downSelector"}\'><div></div></button>        <button class="ui-colorpicker_hue" '+t+'=\'{"mousedown":"downHue"}\'><div></div></button>        <div class="ui-colorpicker_new_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+o+'.css.color.current);" '+t+'=\'{"click":"setColor"}\'></button>        </div>        <div class="ui-colorpicker_current_color ui-colorpicker_transparent">        <button class="ui-colorpicker_color" style="background-color:$('+o+'.css.color);" '+t+'=\'{"click":"restoreColor"}\'></button>        </div>        <div class="ui-colorpicker_field" data-field="hex">        <input name="'+o+'[hex]" type="text" maxlength="6" size="6" value=""/>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.0">        <input name="'+o+'[rgb][0]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.1">        <input name="'+o+'[rgb][1]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="rgb.2">        <input name="'+o+'[rgb][2]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.0">        <input name="'+o+'[hsb][0]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.1">        <input name="'+o+'[hsb][1]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <div class="ui-colorpicker_field" data-field="hsb.2">        <input name="'+o+'[hsb][2]" type="text" maxlength="3" size="3" value=""/><span '+t+'=\'{"mousedown":"downIncrement"}\'></span>        <div class="ui-colorpicker_field_back"></div>        </div>        <button class="ui-colorpicker_submit" '+t+'=\'{"click":"setColor"}\'></button>        </div>        '}function m(){}function v(e){return $({eventName:"click",onShow:m,onBeforeShow:m,onHide:m,onSetColor:m,color:"ff0000",opacity:1,livePreview:!0},e||{})}var g=Math.min,k=Math.max,w=Math.round,$=e.extend,y=/\s*,\s*/g,_=0,x=e.ModelView,C=x.Type.Cast,I=x.Validation.Validate;e.widget("mvc.ColorPicker",e.mvc.ModelViewWidget,{options:{},$view:null,_create:function(){var u,m,w,$,y,x,M,S,P,T,O,A,E,j,H,L,N,Y,z=this,V=z.element,W=0,D=0,X=0;A=z,z.options=v(z.options),E=function(e){return z.$view.$model.set(e.data.type,k(0,g(e.data.max,parseInt(e.data.val+e.pageY-e.data.y,10)))),A.options.livePreview&&z.$view.$model.set(e.data.key,z.$view.$model.get(e.data.key,1),1),!1},j=function(o){return e(document).unbind("mouseup",j).unbind("mousemove",E),W=0,o.data.el.removeClass("ui-colorpicker_slider").find("input").focus(),z.$view.$model.set(o.data.key,z.$view.$model.get(o.data.key,1),1),!1},H=function(e){if(A.options.livePreview){var o=z.$view.$model.$data.hsb;z.$view.$model.set("hsb",[parseInt(360*(148-k(0,g(148,e.pageY-e.data.y)))/148,10),o[1],o[2]],1)}return!1},L=function(o){e(document).unbind("mouseup",L).unbind("mousemove",H),D=0;var t=z.$view.$model.$data.hsb;return z.$view.$model.set("hsb",[parseInt(360*(148-k(0,g(148,o.pageY-o.data.y)))/148,10),t[1],t[2]],1),!1},N=function(e){if(A.options.livePreview){var o=z.$view.$model.$data.hsb;z.$view.$model.set("hsb",[o[0],parseInt(100*k(0,g(150,e.pageX-e.data.pos.left))/150,10),parseInt(100*(150-k(0,g(150,e.pageY-e.data.pos.top)))/150,10)],1)}return!1},Y=function(o){e(document).unbind("mouseup",Y).unbind("mousemove",N),X=0;var t=z.$view.$model.$data.hsb;return z.$view.$model.set("hsb",[t[0],parseInt(100*k(0,g(150,o.pageX-o.data.pos.left))/150,10),parseInt(100*(150-k(0,g(150,o.pageY-o.data.pos.top)))/150,10)],1),!1},y=e(h(m="clrpkrui"+ ++_,w="model_"+m,$="data-bind-"+m)),S=y.find(".ui-colorpicker_hue div")[0],x=y.find(".ui-colorpicker_satur_bright")[0],M=y.find(".ui-colorpicker_satur_bright div")[0],z.$view=y.modelview({id:m,autoSync:!1,bindAttribute:$,livebind:"$(__MODEL__.__KEY__)",autobind:!0,isomorphic:!1,bindbubble:!0,events:["change","blur","focus","mousedown","click"],model:{id:w,data:{opacity:1,hsb:[0,0,0],rgb:[0,0,0],hex:"000000"},types:{opacity:C.COMPOSITE(C.CLAMP(0,1),C.FLOAT),"hsb.0":C.COMPOSITE(C.CLAMP(0,360),C.INT),"hsb.1":C.COMPOSITE(C.CLAMP(0,100),C.INT),"hsb.2":C.COMPOSITE(C.CLAMP(0,100),C.INT),"rgb.*":C.COMPOSITE(C.CLAMP(0,255),C.INT),hex:C.TRIM},validators:{hex:I.MATCH(/^[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]$/i)},getters:{color:function(){return this.$data.rgb},"css.color":function(){return"rgba("+u.join(",")+","+this.$data.opacity+")"},"css.color.current":function(){return"rgba("+this.$data.rgb.join(",")+","+this.$data.opacity+")"},"css.color.rgb":function(){return"rgb("+this.$data.rgb.join(",")+")"},"css.color.hsl":function(){var e=this.$data.hsb;return"hsl("+[e[0],e[1]+"%",e[2]+"%"].join(",")+")"},"css.color.hex":function(){return"#"+this.$data.hex}},setters:{opacity:function(e,o,t){var i=this;i.$data.opacity=o,t&&(i.notify("css.color"),A.element[0].style.backgroundColor=i.get("css.color"))},"css.color":function(e,o,t){var i,n,r=this;o&&o.substring&&(i=o.slice(0,4),"rgba"===i?(n=f(o),r.set("opacity",n[1]).set("rgb",n[0])):"rgb("===i?(n=b(o),r.set("rgb",n)):"hsl("===i?(n=p(o),r.set("hsb",n)):(n=o,r.set("hex","#"===n.charAt(0)?n.slice(1):n)),u=r.$data.rgb.slice(),t&&(r.notify(["hsb","rgb","hex","color"]),A.element[0].style.backgroundColor=r.get("css.color")))},color:function(e,t,i){var n=this;t&&(t.substring?n.set("hex","#"===t.charAt(0)?t.slice(1):t):t.h!==o&&t.s!==o&&t.b!==o?n.set("hsb",[t.h,t.s,t.b]):t.r!==o&&t.g!==o&&t.b!==o?n.set("rgb",[t.r,t.g,t.b]):n.set("rgb",[t[0]||0,t[1]||0,t[2]||0]),u=n.$data.rgb.slice(),i&&(n.notify(["hsb","rgb","hex","css.color"]),A.element[0].style.backgroundColor=n.get("css.color")))},hsb:function(e,o,t){var i,r=this,s=r.$data;i=s.hsb=n(o),s.rgb=l(i),s.hex=d(s.rgb),x.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",M.style.top=150*(100-i[2])/100+"px",M.style.left=150*i[1]/100+"px",S.style.top=148-148*i[0]/360+"px",t&&r.notify(["rgb","hex","css.color.current"])},"hsb.*":function(e,o,t){return this.$data.hsb[parseInt(e.slice(4),10)]=o,t&&this.set("hsb",this.$data.hsb,t),!1},rgb:function(e,o,t){var i,n=this,s=n.$data;s.rgb=r(o),s.hex=d(s.rgb),i=s.hsb=a(s.rgb),x.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",M.style.top=150*(100-i[2])/100+"px",M.style.left=150*i[1]/100+"px",S.style.top=148-148*i[0]/360+"px",t&&n.notify(["hsb","hex","css.color.current"])},"rgb.*":function(e,o,t){return this.$data.rgb[parseInt(e.slice(4),10)]=o,t&&this.set("rgb",this.$data.rgb,t),!1},hex:function(e,o,t){var i,n=this,r=n.$data;r.hex=s(o),r.rgb=c(r.hex),i=r.hsb=a(r.rgb),x.style.backgroundColor="rgb("+l([i[0],100,100]).join(",")+")",M.style.top=150*(100-i[2])/100+"px",M.style.left=150*i[1]/100+"px",S.style.top=148-148*i[0]/360+"px",t&&n.notify(["hsb","rgb","css.color.current"])}}},actions:{setColor:function(){this.$model.set("color",this.$model.$data.rgb,1),T&&T(!0),A.options.onSetColor(A.element)},restoreColor:function(){this.$model.set("color",u,1)},downIncrement:function(o,t){if(!W){var i=e(t.parentNode).addClass("ui-colorpicker_slider"),n=i.attr("data-field"),r=i.find("input").focus(),s={el:i,type:n,key:n.slice(0,3),max:"hsb.0"===n?360:0===n.indexOf("hsb")?100:255,y:o.pageY,field:r,val:parseInt(r.val(),10)};W=1,e(document).bind("mouseup",s,j).bind("mousemove",s,E)}},downHue:function(o,t){if(!D){var i={y:e(t).offset().top};D=1,e(document).bind("mouseup",i,L).bind("mousemove",i,H)}},downSelector:function(o,t){if(!X){var i={pos:e(t).offset()};X=1,e(document).bind("mouseup",i,Y).bind("mousemove",i,N)}}}}).modelview("view"),z.$view.$model.set("opacity",A.options.opacity).set("color",A.options.color),V.hasClass("ui-colorpicker-flat")?y.addClass("ui-colorpicker-flat").appendTo(V).show():(O=function(e){27===e.keyCode&&T(!0)},T=function B(o){y.hasClass("ui-colorpicker-visible")&&(!0===o||o.target!==V[0]&&!i(y[0],o.target,y[0]))&&(!1!==A.options.onHide(y)&&y.removeClass("ui-colorpicker-visible"),e(document).unbind("keyup",O).unbind("mousedown",B))},P=function(){if(!y.hasClass("ui-colorpicker-visible")){A.options.onBeforeShow(y);var o=e(this).offset(),i=t(),n=o.top+this.offsetHeight,r=o.left;n+176>i.t+i.h&&(n-=this.offsetHeight+176),r+356>i.l+i.w&&(r-=356),y.css({left:r+"px",top:n+"px"}),!1!==A.options.onShow(y)&&y.addClass("ui-colorpicker-visible"),e(document).bind("keyup",O).bind("mousedown",T)}return!1},y.appendTo(document.body),V.bind(z.options.eventName,P)),z.$view.sync(),V.addClass("ui-colorselector").css("background-color",z.$view.$model.get("css.color")),V.hasClass("ui-colorpicker-light")&&y.addClass("ui-colorpicker-light"),V.hasClass("ui-colorpicker-transition-fade")&&y.addClass("ui-colorpicker-transition-fade"),V.hasClass("ui-colorpicker-transition-slide")&&y.addClass("ui-colorpicker-transition-slide")},color:function(e){var o=this,t=arguments.length;return t?(o.$view.$model.set("color",e,1),o.element):o.$view.$model.get("css.color")},opacity:function(e){var o=this,t=arguments.length;return t?(o.$view.$model.set("opacity",e,1),o.element):o.$view.$model.get("opacity")}})}(jQuery);