/*  
 *  DSP.js - a comprehensive digital signal processing  library for javascript 
 *  
 *  Created by Corban Brook <corbanbrook@gmail.com> on 2010-01-01.
 *  Copyright 2010 Corban Brook. All rights reserved.
 *
 */
Float32Array=typeof Float32Array==="undefined"?Array:Float32Array;Float64Array=typeof Float64Array==="undefined"?Array:Float64Array;Uint32Array=typeof Uint32Array==="undefined"?Array:Uint32Array;
DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI,invert:function(a){for(var c=0,b=a.length;c<b;c++)a[c]*=-1;return a},interleave:function(a,c){if(a.length!==c.length)throw"Can not interleave. Channel lengths differ.";for(var b=new Float32Array(a.length*2),d=0,e=a.length;d<e;d++)b[2*d]=a[d],b[2*d+1]=c[d];
return b},deinterleave:function(a){for(var c=new Float32Array(a.length/2),b=new Float32Array(a.length/2),d=new Float32Array(a.length/2),e=0,f=a.length/2;e<f;e++)c[e]=a[2*e],b[e]=a[2*e+1],d[e]=(c[e]+b[e])/2;return[c,b,d]}};DSP.getChannel=function(a,c){return DSP.deinterleave(c)[a]};DSP.LPF=0;DSP.HPF=1;DSP.BPF_CONSTANT_SKIRT=2;DSP.BPF_CONSTANT_PEAK=3;DSP.NOTCH=4;DSP.APF=5;DSP.PEAKING_EQ=6;DSP.LOW_SHELF=7;DSP.HIGH_SHELF=8;DSP.Q=1;DSP.BW=2;DSP.S=3;
DFT=function(a,c){this.bufferSize=a;this.sampleRate=c;var b=a/2*a;this.sinTable=new Float32Array(b);this.cosTable=new Float32Array(b);for(var d=0;d<b;d++)this.sinTable[d]=Math.sin(d*DSP.TWO_PI/a),this.cosTable[d]=Math.cos(d*DSP.TWO_PI/a);this.spectrum=new Float32Array(a/2);this.complexValues=new Float32Array(a/2)};
DFT.prototype.forward=function(a){for(var c,b,d=0;d<this.bufferSize/2;d++){for(var e=b=c=0;e<a.length;e++)c+=this.cosTable[d*e]*signal[e],b+=this.sinTable[d*e]*signal[e];this.complexValues[d]={real:c,imag:b}}for(a=0;a<this.bufferSize/2;a++)this.spectrum[a]=2*Math.sqrt(Math.pow(this.complexValues[a].real,2)+Math.pow(this.complexValues[a].imag,2))/this.bufferSize;return this.spectrum};
FFT=function(a,c){this.bufferSize=a;this.sampleRate=c;this.spectrum=new Float32Array(a/2);this.real=new Float32Array(a);this.imag=new Float32Array(a);this.reverseTable=new Uint32Array(a);for(var b=1,d=a>>1;b<a;){for(var e=0;e<b;e++)this.reverseTable[e+b]=this.reverseTable[e]+d;b<<=1;d>>=1}this.sinTable=new Float32Array(a);this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)};
FFT.prototype.forward=function(a){var c=this.bufferSize,b=this.cosTable,d=this.sinTable,e=this.reverseTable,f=this.real,g=this.imag,l=this.spectrum;if(Math.pow(2,Math.floor(Math.log(c)/Math.LN2))!==c)throw"Invalid buffer size, must be a power of 2.";if(c!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+c+" Buffer Size: "+a.length;for(var h=0;h<c;h++)f[h]=a[e[h]],g[h]=0;for(var a=1,i,j,k,m,n,o;a<c;){e=b[a];i=d[a];j=1;for(var p=k=0;p<a;p++){for(h=p;h<c;)m=h+a,n=j*f[m]-
k*g[m],o=j*g[m]+k*f[m],f[m]=f[h]-n,g[m]=g[h]-o,f[h]+=n,g[h]+=o,h+=a<<1;h=j;j=h*e-k*i;k=h*i+k*e}a<<=1}for(h=c/2;h--;)l[h]=2*Math.sqrt(f[h]*f[h]+g[h]*g[h])/c;return l};
FFT.prototype.inverse=function(a,c){for(var b=this.bufferSize,d=this.cosTable,e=this.sinTable,f=this.reverseTable,a=a||this.real,c=c||this.imag,g=0;g<b;g++)c[g]*=-1;for(var l=new Float32Array(b),h=new Float32Array(b),g=0;g<a.length;g++)l[g]=a[f[g]],h[g]=c[f[g]];for(var a=l,c=h,f=1,i,j,k,m,n;f<b;){l=d[f];h=e[f];i=1;for(var o=j=0;o<f;o++){for(g=o;g<b;)k=g+f,m=i*a[k]-j*c[k],n=i*c[k]+j*a[k],a[k]=a[g]-m,c[k]=c[g]-n,a[g]+=m,c[g]+=n,g+=f<<1;g=i;i=g*l-j*h;j=g*h+j*l}f<<=1}d=new Float32Array(b);for(g=0;g<b;g++)d[g]=
a[g]/b;return d};
Sampler=function(a,c,b,d,e,f,g,l){this.file=a;this.bufferSize=c;this.sampleRate=b;this.playStart=d||0;this.playEnd=e||1;this.loopStart=f||0;this.loopEnd=g||1;this.loopMode=l||DSP.OFF;this.loaded=!1;this.samples=[];this.signal=new Float32Array(c);this.frameCount=0;this.envelope=null;this.amplitude=1;this.rootFrequency=110;this.frequency=550;this.step=this.frequency/this.rootFrequency;this.playhead=this.samplesProcessed=this.duration=0;var h=document.createElement("AUDIO"),i=this;this.loadSamples=function(a){for(var a=
DSP.getChannel(DSP.MIX,a.frameBuffer),b=0;b<a.length;b++)i.samples.push(a[b])};this.loadComplete=function(){i.samples=new Float32Array(i.samples);i.loaded=!0};this.loadMetaData=function(){i.duration=h.duration};h.addEventListener("MozAudioAvailable",this.loadSamples,!1);h.addEventListener("loadedmetadata",this.loadMetaData,!1);h.addEventListener("ended",this.loadComplete,!1);h.muted=!0;h.src=a;h.play()};Sampler.prototype.applyEnvelope=function(){this.envelope.process(this.signal);return this.signal};
Sampler.prototype.generate=function(){for(var a=this.playEnd*this.samples.length-this.playStart*this.samples.length,c=this.playStart*this.samples.length,b=this.playEnd*this.samples.length,d=0;d<this.bufferSize;d++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+c);this.signal[d]=this.playhead<this.playEnd*this.samples.length?this.samples[this.playhead]*this.amplitude:0;break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%a+c);this.playhead<
this.playEnd*this.samples.length&&(this.signal[d]=this.samples[this.playhead]*this.amplitude);break;case DSP.BW:this.playhead=b-Math.round(this.samplesProcessed*this.step%a);this.playhead<this.playEnd*this.samples.length&&(this.signal[d]=this.samples[this.playhead]*this.amplitude);break;case DSP.FWBW:this.playhead=Math.floor(this.samplesProcessed*this.step/a)%2==0?Math.round(this.samplesProcessed*this.step%a+c):b-Math.round(this.samplesProcessed*this.step%a),this.playhead<this.playEnd*this.samples.length&&
(this.signal[d]=this.samples[this.playhead]*this.amplitude)}this.samplesProcessed++}this.frameCount++;return this.signal};Sampler.prototype.setFreq=function(a){this.frequency=a;this.step=this.frequency/this.rootFrequency};Sampler.prototype.reset=function(){this.playhead=this.samplesProcessed=0};
Oscillator=function Oscillator(c,b,d,e,f){this.frequency=b;this.amplitude=d;this.bufferSize=e;this.sampleRate=f;this.frameCount=0;this.waveTableLength=2048;this.cyclesPerSample=b/f;this.signal=new Float32Array(e);this.envelope=null;switch(parseInt(c)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:this.func=Oscillator.Sine}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);
for(var b=1/(this.waveTableLength/this.sampleRate),c=0;c<this.waveTableLength;c++)Oscillator.waveTable[this.func][c]=this.func(c*b/this.sampleRate)};if(typeof Oscillator.waveTable==="undefined")Oscillator.waveTable={};typeof Oscillator.waveTable[this.func]==="undefined"&&this.generateWaveTable();this.waveTable=Oscillator.waveTable[this.func]};Oscillator.prototype.setAmp=function(a){if(a>=0&&a<=1)this.amplitude=a;else throw"Amplitude out of range (0..1).";};
Oscillator.prototype.setFreq=function(a){this.frequency=a;this.cyclesPerSample=a/this.sampleRate};Oscillator.prototype.add=function(a){for(var c=0;c<this.bufferSize;c++)this.signal[c]+=a.signal[c];return this.signal};Oscillator.prototype.addSignal=function(a){for(var c=0;c<a.length;c++){if(c>=this.bufferSize)break;this.signal[c]+=a[c]}return this.signal};Oscillator.prototype.addEnvelope=function(a){this.envelope=a};Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)};
Oscillator.prototype.valueAt=function(a){return this.waveTable[a%this.waveTableLength]};Oscillator.prototype.generate=function(){for(var a=this.frameCount*this.bufferSize,c=this.waveTableLength*this.frequency/this.sampleRate,b,d=0;d<this.bufferSize;d++)b=Math.round((a+d)*c),this.signal[d]=this.waveTable[b%this.waveTableLength]*this.amplitude;this.frameCount++;return this.signal};Oscillator.Sine=function(a){return Math.sin(DSP.TWO_PI*a)};Oscillator.Square=function(a){return a<0.5?1:-1};
Oscillator.Saw=function(a){return 2*(a-Math.round(a))};Oscillator.Triangle=function(a){return 1-4*Math.abs(Math.round(a)-a)};Oscillator.Pulse=function(){};
ADSR=function(a,c,b,d,e,f){this.sampleRate=f;this.attackLength=a;this.decayLength=c;this.sustainLevel=b;this.sustainLength=d;this.releaseLength=e;this.sampleRate=f;this.attackSamples=a*f;this.decaySamples=c*f;this.sustainSamples=d*f;this.releaseSamples=e*f;this.update=function(){this.attack=this.attackSamples;this.decay=this.attack+this.decaySamples;this.sustain=this.decay+this.sustainSamples;this.release=this.sustain+this.releaseSamples};this.update();this.samplesProcessed=0};
ADSR.prototype.noteOn=function(){this.samplesProcessed=0;this.sustainSamples=this.sustainLength*this.sampleRate;this.update()};ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples;this.update()};
ADSR.prototype.processSample=function(a){var c=0;this.samplesProcessed<=this.attack?c=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?c=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?c=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(c=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-
this.sustain)/(this.release-this.sustain)));return a*c};
ADSR.prototype.value=function(){var a=0;this.samplesProcessed<=this.attack?a=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?a=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?a=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(a=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-
this.sustain)/(this.release-this.sustain)));return a};ADSR.prototype.process=function(a){for(var c=0;c<a.length;c++)a[c]*=this.value(),this.samplesProcessed++;return a};ADSR.prototype.isActive=function(){return this.samplesProcessed>this.release||this.samplesProcessed===-1?!1:!0};ADSR.prototype.disable=function(){this.samplesProcessed=-1};IIRFilter=function(a,c,b,d){this.sampleRate=d;this.cutoff=c;this.resonance=b;switch(a){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(c,b,d)}};
IIRFilter.prototype.set=function(a,c){this.func.calcCoeff(a,c)};IIRFilter.prototype.process=function(a){this.func.process(a)};IIRFilter.prototype.addEnvelope=function(a){if(a instanceof ADSR)this.func.addEnvelope(a);else throw"Not an envelope.";};
IIRFilter.LP12=function(a,c,b){this.sampleRate=b;this.vibraSpeed=this.vibraPos=0;this.envelope=!1;this.calcCoeff=function(a,b){this.w=2*Math.PI*a/this.sampleRate;this.q=1-this.w/(2*(b+0.5/(1+this.w))+this.w-2);this.r=this.q*this.q;this.c=this.r+1-2*Math.cos(this.w)*this.q;this.cutoff=a;this.resonance=b};this.calcCoeff(a,c);this.process=function(a){for(var b=0;b<a.length;b++)this.vibraSpeed+=(a[b]-this.vibraPos)*this.c,this.vibraPos+=this.vibraSpeed,this.vibraSpeed*=this.r,this.envelope?(a[b]=a[b]*
(1-this.envelope.value())+this.vibraPos*this.envelope.value(),this.envelope.samplesProcessed++):a[b]=this.vibraPos}};IIRFilter.LP12.prototype.addEnvelope=function(a){this.envelope=a};
IIRFilter2=function(a,c,b,d){this.type=a;this.cutoff=c;this.resonance=b;this.sampleRate=d;this.f=Float32Array(4);this.f[0]=0;this.f[1]=0;this.f[2]=0;this.f[3]=0;this.calcCoeff=function(a,b){this.freq=2*Math.sin(Math.PI*Math.min(0.25,a/(this.sampleRate*2)));this.damp=Math.min(2*(1-Math.pow(b,0.25)),Math.min(2,2/this.freq-this.freq*0.5))};this.calcCoeff(c,b)};
IIRFilter2.prototype.process=function(a){for(var c,b,d=this.f,e=0;e<a.length;e++)c=a[e],d[3]=c-this.damp*d[2],d[0]+=this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],b=0.5*d[this.type],d[3]=c-this.damp*d[2],d[0]+=this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],b+=0.5*d[this.type],this.envelope?(a[e]=a[e]*(1-this.envelope.value())+b*this.envelope.value(),this.envelope.samplesProcessed++):a[e]=b};
IIRFilter2.prototype.addEnvelope=function(a){if(a instanceof ADSR)this.envelope=a;else throw"This is not an envelope.";};IIRFilter2.prototype.set=function(a,c){this.calcCoeff(a,c)};
WindowFunction=function(a,c){this.alpha=c;switch(a){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman;this.alpha=this.alpha||0.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss;this.alpha=this.alpha||0.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;
case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular}};WindowFunction.prototype.process=function(a){for(var c=a.length,b=0;b<c;b++)a[b]*=this.func(c,b,this.alpha);return a};WindowFunction.Bartlett=function(a,c){return 2/(a-1)*((a-1)/2-Math.abs(c-(a-1)/2))};WindowFunction.BartlettHann=function(a,c){return 0.62-0.48*Math.abs(c/(a-1)-0.5)-0.38*Math.cos(DSP.TWO_PI*c/(a-1))};
WindowFunction.Blackman=function(a,c,b){return(1-b)/2-0.5*Math.cos(DSP.TWO_PI*c/(a-1))+b/2*Math.cos(4*Math.PI*c/(a-1))};WindowFunction.Cosine=function(a,c){return Math.cos(Math.PI*c/(a-1)-Math.PI/2)};WindowFunction.Gauss=function(a,c,b){return Math.pow(Math.E,-0.5*Math.pow((c-(a-1)/2)/(b*(a-1)/2),2))};WindowFunction.Hamming=function(a,c){return 0.54-0.46*Math.cos(DSP.TWO_PI*c/(a-1))};WindowFunction.Hann=function(a,c){return 0.5*(1-Math.cos(DSP.TWO_PI*c/(a-1)))};
WindowFunction.Lanczos=function(a,c){var b=2*c/(a-1)-1;return Math.sin(Math.PI*b)/(Math.PI*b)};WindowFunction.Rectangular=function(){return 1};WindowFunction.Triangular=function(a,c){return 2/a*(a/2-Math.abs(c-(a-1)/2))};function sinh(a){return(Math.exp(a)-Math.exp(-a))/2}
Biquad=function(a,c){this.Fs=c;this.type=a;this.parameterType=DSP.Q;this.y_2_r=this.y_1_r=this.x_2_r=this.x_1_r=this.y_2_l=this.y_1_l=this.x_2_l=this.x_1_l=0;this.a0=this.b0=1;this.a2=this.b2=this.a1=this.b1=0;this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0;this.f0=3E3;this.dBgain=12;this.Q=1;this.BW=-3;this.S=1;this.coefficients=function(){return{b:[this.b0,this.b1,this.b2],a:[this.a0,this.a1,this.a2]}};this.setFilterType=
function(a){this.type=a;this.recalculateCoefficients()};this.setSampleRate=function(a){this.Fs=a;this.recalculateCoefficients()};this.setQ=function(a){this.parameterType=DSP.Q;this.Q=Math.max(Math.min(a,115),0.001);this.recalculateCoefficients()};this.setBW=function(a){this.parameterType=DSP.BW;this.BW=a;this.recalculateCoefficients()};this.setS=function(a){this.parameterType=DSP.S;this.S=Math.max(Math.min(a,5),1.0E-4);this.recalculateCoefficients()};this.setF0=function(a){this.f0=a;this.recalculateCoefficients()};
this.setDbGain=function(a){this.dBgain=a;this.recalculateCoefficients()};this.recalculateCoefficients=function(){var b;b=a==DSP.PEAKING_EQ||a==DSP.LOW_SHELF||a==DSP.HIGH_SHELF?Math.pow(10,this.dBgain/40):Math.sqrt(Math.pow(10,this.dBgain/20));var c=DSP.TWO_PI*this.f0/this.Fs,e=Math.cos(c),f=Math.sin(c),g=0;switch(this.parameterType){case DSP.Q:g=f/(2*this.Q);break;case DSP.BW:g=f*sinh(Math.LN2/2*this.BW*c/f);break;case DSP.S:g=f/2*Math.sqrt((b+1/b)*(1/this.S-1)+2)}switch(this.type){case DSP.LPF:this.b0=
(1-e)/2;this.b1=1-e;this.b2=(1-e)/2;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.HPF:this.b0=(1+e)/2;this.b1=-(1+e);this.b2=(1+e)/2;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=f/2;this.b1=0;this.b2=-f/2;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.BPF_CONSTANT_PEAK:this.b0=g;this.b1=0;this.b2=-g;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.NOTCH:this.b0=1;this.b1=-2*e;this.b2=1;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.APF:this.b0=
1-g;this.b1=-2*e;this.b2=1+g;this.a0=1+g;this.a1=-2*e;this.a2=1-g;break;case DSP.PEAKING_EQ:this.b0=1+g*b;this.b1=-2*e;this.b2=1-g*b;this.a0=1+g/b;this.a1=-2*e;this.a2=1-g/b;break;case DSP.LOW_SHELF:c=f*Math.sqrt((b^3)*(1/this.S-1)+2*b);this.b0=b*(b+1-(b-1)*e+c);this.b1=2*b*(b-1-(b+1)*e);this.b2=b*(b+1-(b-1)*e-c);this.a0=b+1+(b-1)*e+c;this.a1=-2*(b-1+(b+1)*e);this.a2=b+1+(b-1)*e-c;break;case DSP.HIGH_SHELF:c=f*Math.sqrt((b^3)*(1/this.S-1)+2*b),this.b0=b*(b+1+(b-1)*e+c),this.b1=-2*b*(b-1+(b+1)*e),
this.b2=b*(b+1+(b-1)*e-c),this.a0=b+1-(b-1)*e+c,this.a1=2*(b-1-(b+1)*e),this.a2=b+1-(b-1)*e-c}this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0};this.process=function(a){for(var c=new Float32Array(a.length),e=0;e<a.length;e++)c[e]=this.b0a0*a[e]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=c[e],this.x_2_l=this.x_1_l,this.x_1_l=a[e];return c};this.processStereo=
function(a){for(var c=a.length,e=new Float32Array(c),f=0;f<c/2;f++)e[2*f]=this.b0a0*a[2*f]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=e[2*f],this.x_2_l=this.x_1_l,this.x_1_l=a[2*f],e[2*f+1]=this.b0a0*a[2*f+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r,this.y_2_r=this.y_1_r,this.y_1_r=e[2*f+1],this.x_2_r=this.x_1_r,this.x_1_r=a[2*f+1];return e}};
DSP.mag2db=function(a){for(var c=Math.pow(10,-6),b=Math.log,d=Math.max,e=Float32Array(a.length),f=0;f<a.length;f++)e[f]=20*b(d(a[f],c));return e};
DSP.freqz=function(a,c,b){if(!b)for(var b=Float32Array(200),d=0;d<b.length;d++)b[d]=DSP.TWO_PI/b.length*d-Math.PI;for(var e=Float32Array(b.length),f=Math.sqrt,g=Math.cos,l=Math.sin,d=0;d<b.length;d++){for(var h={real:0,imag:0},i=0;i<a.length;i++)h.real+=a[i]*g(-i*b[d]),h.imag+=a[i]*l(-i*b[d]);for(var j={real:0,imag:0},i=0;i<c.length;i++)j.real+=c[i]*g(-i*b[d]),j.imag+=c[i]*l(-i*b[d]);e[d]=f(h.real*h.real+h.imag*h.imag)/f(j.real*j.real+j.imag*j.imag)}return e};
GraphicalEq=function(a){this.FS=a;this.minFreq=40;this.maxFreq=16E3;this.bandsPerOctave=1;this.filters=[];this.freqzs=[];this.calculateFreqzs=!0;this.recalculateFilters=function(){var a=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var b=0;b<a;b++){var d=this.minFreq*Math.pow(2,b/this.bandsPerOctave),e=new Biquad(DSP.PEAKING_EQ,this.FS);e.setDbGain(0);e.setBW(1/this.bandsPerOctave);e.setF0(d);this.filters[b]=e;this.recalculateFreqz(b)}};this.setMinimumFrequency=
function(a){this.minFreq=a;this.recalculateFilters()};this.setMaximumFrequency=function(a){this.maxFreq=a;this.recalculateFilters()};this.setBandsPerOctave=function(a){this.bandsPerOctave=a;this.recalculateFilters()};this.setBandGain=function(a,b){if(a<0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds.";if(!b)throw"A gain must be passed.";this.filters[a].setDbGain(b);this.recalculateFreqz(a)};this.recalculateFreqz=function(a){if(this.calculateFreqzs){if(a<
0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds. "+a+" is out of [0, "+this.filters.length-1+"]";if(!this.w){this.w=Float32Array(400);for(var b=0;b<this.w.length;b++)this.w[b]=Math.PI/this.w.length*b}this.freqzs[a]=DSP.mag2db(DSP.freqz([this.filters[a].b0,this.filters[a].b1,this.filters[a].b2],[this.filters[a].a0,this.filters[a].a1,this.filters[a].a2],this.w))}};this.process=function(a){for(var b=0;b<this.filters.length;b++)a=this.filters[b].process(a);
return a};this.processStereo=function(a){for(var b=0;b<this.filters.length;b++)a=this.filters[b].processStereo(a);return a}};MultiDelay=function(a,c,b,d){this.delayBufferSamples=new Float32Array(a);this.delayInputPointer=c;this.delayOutputPointer=0;this.delayInSamples=c;this.masterVolume=b;this.delayVolume=d};
MultiDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a;this.delayInputPointer=this.delayOutputPointer+a;this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer-=this.delayBufferSamples.length)};MultiDelay.prototype.setMasterVolume=function(a){this.masterVolume=a};MultiDelay.prototype.setDelayVolume=function(a){this.delayVolume=a};
MultiDelay.prototype.process=function(a){for(var c=new Float32Array(a.length),b=0;b<a.length;b++){var d=(this.delayBufferSamples[this.delayOutputPointer]==null?0:this.delayBufferSamples[this.delayOutputPointer])*this.delayVolume+a[b];this.delayBufferSamples[this.delayInputPointer]=d;c[b]=d*this.masterVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1)this.delayInputPointer=0;this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-
1)this.delayOutputPointer=0}return c};SingleDelay=function(a,c,b){this.delayBufferSamples=new Float32Array(a);this.delayInputPointer=c;this.delayOutputPointer=0;this.delayInSamples=c;this.delayVolume=b};SingleDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a;this.delayInputPointer=this.delayOutputPointer+a;this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer-=this.delayBufferSamples.length)};
SingleDelay.prototype.setDelayVolume=function(a){this.delayVolume=a};
SingleDelay.prototype.process=function(a){for(var c=new Float32Array(a.length),b=0;b<a.length;b++){this.delayBufferSamples[this.delayInputPointer]=a[b];c[b]=this.delayBufferSamples[this.delayOutputPointer]*this.delayVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1)this.delayInputPointer=0;this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-1)this.delayOutputPointer=0}return c};
Reverb=function(a,c,b,d,e,f){this.delayInSamples=c;this.masterVolume=b;this.mixVolume=d;this.delayVolume=e;this.dampFrequency=f;this.NR_OF_SINGLEDELAYS=this.NR_OF_MULTIDELAYS=6;this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,f,0,44100);this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,f,0,44100);this.singleDelays=[];for(c=0;c<this.NR_OF_SINGLEDELAYS;c++)b=1+c/7,this.singleDelays[c]=new SingleDelay(a,Math.round(this.delayInSamples*b),this.delayVolume);this.multiDelays=[];for(c=0;c<this.NR_OF_MULTIDELAYS;c++)b=1+c/
10,this.multiDelays[c]=new MultiDelay(a,Math.round(this.delayInSamples*b),this.masterVolume,this.delayVolume)};Reverb.prototype.setDelayInSamples=function(a){this.delayInSamples=a;for(a=0;a<this.NR_OF_SINGLEDELAYS;a++){var c=1+a/7;this.singleDelays[a].setDelayInSamples(Math.round(this.delayInSamples*c))}for(a=0;a<this.NR_OF_MULTIDELAYS;a++)c=1+a/10,this.multiDelays[a].setDelayInSamples(Math.round(this.delayInSamples*c))};Reverb.prototype.setMasterVolume=function(a){this.masterVolume=a};
Reverb.prototype.setMixVolume=function(a){this.mixVolume=a};Reverb.prototype.setDelayVolume=function(a){this.delayVolume=a;for(a=0;a<this.NR_OF_SINGLEDELAYS;a++)this.singleDelays[a].setDelayVolume(this.delayVolume);for(a=0;a<this.NR_OF_MULTIDELAYS;a++)this.multiDelays[a].setDelayVolume(this.delayVolume)};Reverb.prototype.setDampFrequency=function(a){this.dampFrequency=a;this.LOWPASSL.set(a,0);this.LOWPASSR.set(a,0)};
Reverb.prototype.process=function(a){var c=new Float32Array(a.length),b=DSP.deinterleave(a);this.LOWPASSL.process(b[DSP.LEFT]);this.LOWPASSR.process(b[DSP.RIGHT]);for(var d=DSP.interleave(b[DSP.LEFT],b[DSP.RIGHT]),b=0;b<this.NR_OF_MULTIDELAYS;b++)c=mixSampleBuffers(c,this.multiDelays[b].process(d),2%b==0,this.NR_OF_MULTIDELAYS);d=new Float32Array(c.length);for(b=0;b<this.NR_OF_SINGLEDELAYS;b++)d=mixSampleBuffers(d,this.singleDelays[b].process(c),2%b==0,1);for(b=0;b<d.length;b++)d[b]*=this.mixVolume;
c=mixSampleBuffers(d,a,0,1);for(b=0;b<c.length;b++)c[b]*=this.masterVolume;return c};function mixSampleBuffers(a,c,b,d){for(var e=new Float32Array(a),f=0;f<a.length;f++)e[f]+=(b?-c[f]:c[f])/d;return e};
