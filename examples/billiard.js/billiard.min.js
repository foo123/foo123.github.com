/**************************************************
** BILLIARD.js minified
** javascript implementation of American and French Billiard Games with HTML5 canvas and NEngine.js
** Nikos M.
** url http://nikos-web-development.netai.net/
*****************************************************/
var BILLIARD=BILLIARD||{};BILLIARD.SimplePoint=function(a,b){this.x=0,this.y=0,typeof a=="undefined"&&(a=0),typeof b=="undefined"&&(b=0),this.update(a,b)},BILLIARD.SimplePoint.prototype.update=function(a,b){this.x=BILLIARD.Ball.correctFloatingPointError(a),this.y=BILLIARD.Ball.correctFloatingPointError(b);return},BILLIARD.TriangleData=function(){this.p0=0,this.vy=0,this.p1=0,this.vx=0,this.dx=0,this.len=0,this.dy=0,this.p0=new BILLIARD.SimplePoint,this.p1=new BILLIARD.SimplePoint},BILLIARD.TriangleData.prototype.refresh=function(a){typeof a=="undefined"&&(a=!1),a?(this.vx=BILLIARD.Ball.correctFloatingPointError(this.p1.x-this.p0.x),this.vy=BILLIARD.Ball.correctFloatingPointError(this.p1.y-this.p0.y)):this.p1.update(this.p0.x+this.vx,this.p0.y+this.vy),this.len=BILLIARD.TriangleData.getHypotenuse(this.vx,this.vy),this.len>0?(this.dx=BILLIARD.Ball.correctFloatingPointError(this.vx/this.len),this.dy=BILLIARD.Ball.correctFloatingPointError(this.vy/this.len)):(this.dx=0,this.dy=0)},BILLIARD.TriangleData.getHypotenuse=function(a,b){return BILLIARD.Ball.correctFloatingPointError(Math.sqrt(a*a+b*b))},BILLIARD.CollisionResult=function(a,b,c,d){this.p0=null,this.p1=null,typeof a=="undefined"&&(a=0),typeof b=="undefined"&&(b=0),typeof c=="undefined"&&(c=0),typeof d=="undefined"&&(d=0),this.p0=new BILLIARD.SimplePoint(a,b),this.p1=new BILLIARD.SimplePoint(c,d)},BILLIARD.Ball=function(a,b){this.proccess_time=null,this.collision_target_time=null,this.collision=!1,this.m=1,this.dragging=!1,this.direction=null,this.last_collision_time=null,this.r=1,this.target=null,this.line_limit_x=null,this.vx=null,this.vy=null,this.colour=null,this.collision_wall_detail=null,this.status=null,typeof b=="undefined"&&(b=2),this.type=b,NEngine.Shape.call(this),this.cacheCanvas=document.createElement("canvas");var c=this;this.image=new Image,this.image.onload=function(){c.cacheCanvas.width=c.image.width,c.cacheCanvas.height=c.image.height;var a=c.cacheCanvas.getContext("2d");a.drawImage(c.image,0,0),c.width=c.image.width,c.height=c.image.height,c.regX=c.image.width/2,c.regY=c.image.height/2,c.r=c.image.width/2-1},this.direction=new BILLIARD.TriangleData,this.direction.p0.update(this.x,this.y),this.collision=!1,this.status=0,this.dragging=!1,this.line_limit_x=538+this.r,this.updateProccessTime(1),this.image.src=a},BILLIARD.Ball.w={x1:29,y1:35,x2:556,y2:326},BILLIARD.Ball.isPositionOverlapped=function(){return null},BILLIARD.Ball.inheritsFrom(NEngine.Shape),BILLIARD.Ball.prototype.draw=function(a,b){this.__draw(a,b)},BILLIARD.Ball.simulateElasticCollision=function(a,b){var c=null,d=NaN,e=null,f=null,g=NaN,h=NaN,i=NaN,j=NaN,k=NaN,l=NaN,m=null,n=null,o=null,p=null;return c=new BILLIARD.SimplePoint(b.direction.p0.x-a.direction.p0.x,b.direction.p0.y-a.direction.p0.y),d=BILLIARD.TriangleData.getHypotenuse(c.x,c.y),e=new BILLIARD.SimplePoint(c.x/d,c.y/d),f=new BILLIARD.SimplePoint(-e.y,e.x),g=BILLIARD.Ball.correctFloatingPointError(e.x*a.direction.vx+e.y*a.direction.vy),h=BILLIARD.Ball.correctFloatingPointError(f.x*a.direction.vx+f.y*a.direction.vy),i=BILLIARD.Ball.correctFloatingPointError(e.x*b.direction.vx+e.y*b.direction.vy),j=BILLIARD.Ball.correctFloatingPointError(f.x*b.direction.vx+f.y*b.direction.vy),k=BILLIARD.Ball.correctFloatingPointError((g*(a.m-b.m)+2*b.m*i)/(a.m+b.m)),l=BILLIARD.Ball.correctFloatingPointError((i*(b.m-a.m)+2*a.m*g)/(a.m+b.m)),m=new BILLIARD.SimplePoint(e.x*k,e.y*k),n=new BILLIARD.SimplePoint(f.x*h,f.y*h),o=new BILLIARD.SimplePoint(e.x*l,e.y*l),p=new BILLIARD.SimplePoint(f.x*j,f.y*j),new BILLIARD.CollisionResult(BILLIARD.Ball.correctFloatingPointError(m.x+n.x),BILLIARD.Ball.correctFloatingPointError(m.y+n.y),BILLIARD.Ball.correctFloatingPointError(o.x+p.x),BILLIARD.Ball.correctFloatingPointError(o.y+p.y))},BILLIARD.Ball.findTimeUntilCollide=function(a,b){var c=NaN,d=NaN,e=NaN,f=NaN,g=NaN,h=NaN;return c=-1,d=BILLIARD.Ball.correctFloatingPointError(Math.pow(b.vx-a.vx,2)+Math.pow(b.vy-a.vy,2)),e=BILLIARD.Ball.correctFloatingPointError(2*((b.direction.p0.x-a.direction.p0.x)*(b.vx-a.vx)+(b.direction.p0.y-a.direction.p0.y)*(b.vy-a.vy))),f=BILLIARD.Ball.correctFloatingPointError(Math.pow(b.direction.p0.x-a.direction.p0.x,2)+Math.pow(b.direction.p0.y-a.direction.p0.y,2)-Math.pow(a.r+b.r,2)),g=BILLIARD.Ball.correctFloatingPointError(Math.pow(e,2)-4*d*f),d!=0&&(h=BILLIARD.Ball.correctFloatingPointError((-e-Math.sqrt(g))/(2*d)),h>=0&&(c=h)),c},BILLIARD.Ball.stillOnTable=function(a,b,c){var d=BILLIARD.Ball.w;return a-c>=d.x1&&a+c<=d.x2&&b-c>=d.y1&&b+c<=d.y2},BILLIARD.Ball.correctFloatingPointError=function(a,b){typeof b=="undefined"&&(b=10);var c=NaN;return c=Math.pow(10,b),Math.round(c*a)/c},BILLIARD.Ball.doElasticCollision=function(a,b){var c=null,d=NaN,e=null,f=null,g=NaN,h=NaN,i=NaN,j=NaN,k=NaN,l=NaN,m=null,n=null,o=null,p=null;c=new BILLIARD.SimplePoint(b.direction.p0.x-a.direction.p0.x,b.direction.p0.y-a.direction.p0.y),d=BILLIARD.TriangleData.getHypotenuse(c.x,c.y),e=new BILLIARD.SimplePoint(c.x/d,c.y/d),f=new BILLIARD.SimplePoint(-e.y,e.x),g=BILLIARD.Ball.correctFloatingPointError(e.x*a.vx+e.y*a.vy),h=BILLIARD.Ball.correctFloatingPointError(f.x*a.vx+f.y*a.vy),i=BILLIARD.Ball.correctFloatingPointError(e.x*b.vx+e.y*b.vy),j=BILLIARD.Ball.correctFloatingPointError(f.x*b.vx+f.y*b.vy),k=BILLIARD.Ball.correctFloatingPointError((g*(a.m-b.m)+2*b.m*i)/(a.m+b.m)),l=BILLIARD.Ball.correctFloatingPointError((i*(b.m-a.m)+2*a.m*g)/(a.m+b.m)),m=new BILLIARD.SimplePoint(e.x*k,e.y*k),n=new BILLIARD.SimplePoint(f.x*h,f.y*h),o=new BILLIARD.SimplePoint(e.x*l,e.y*l),p=new BILLIARD.SimplePoint(f.x*j,f.y*j),a.direction.vx=BILLIARD.Ball.correctFloatingPointError(m.x+n.x),a.direction.vy=BILLIARD.Ball.correctFloatingPointError(m.y+n.y),a.collision=!0,b.direction.vx=BILLIARD.Ball.correctFloatingPointError(o.x+p.x),b.direction.vy=BILLIARD.Ball.correctFloatingPointError(o.y+p.y),b.collision=!0},BILLIARD.Ball.doElasticCollisionWithWall=function(a,b){switch(b.y){case 1:a.direction.vx=Math.abs(a.vx),a.direction.refresh();break;case 2:a.direction.vy=Math.abs(a.vy),a.direction.refresh();break;case 3:a.direction.vx=-Math.abs(a.vx),a.direction.refresh();break;case 4:a.direction.vy=-Math.abs(a.vy),a.direction.refresh();break;default:}},BILLIARD.Ball.findTimeUntilCollideWithWall=function(a){var b=null,c=!1,d=NaN;b=new BILLIARD.SimplePoint,b.x=-1,c=!1,d=0;var e=BILLIARD.Ball.w;return a.direction.vx<0&&(d=BILLIARD.Ball.correctFloatingPointError((a.r-a.direction.p0.x+e.x1)/a.vx),d>=0&&(b.y=1,b.x=d,c=!0)),a.direction.vy<0&&(d=BILLIARD.Ball.correctFloatingPointError((a.r-a.direction.p0.y+e.y1)/a.vy),d>=0&&(!c||d<b.x)&&(b.y=2,b.x=d,c=!0)),a.direction.vx>0&&(d=BILLIARD.Ball.correctFloatingPointError((e.x2-a.r-a.direction.p0.x)/a.vx),d>=0&&(!c||d<b.x)&&(b.y=3,b.x=d,c=!0)),a.direction.vy>0&&(d=BILLIARD.Ball.correctFloatingPointError((e.y2-a.r-a.direction.p0.y)/a.vy),d>=0&&(!c||d<b.x)&&(b.y=4,b.x=d,c=!0)),b},BILLIARD.Ball.prototype.allowDrag=function(a){this.dragging=!1,this.onMouseDown=null,this.mouseEnabled=!1,this.useHandCursor=!1;return},BILLIARD.Ball.prototype.affectSpeed=function(a){typeof param1=="undefined"&&(a=.975);var b=a;this.direction.vx=BILLIARD.Ball.correctFloatingPointError(this.direction.vx*b),this.direction.vy=BILLIARD.Ball.correctFloatingPointError(this.direction.vy*b),Math.abs(this.direction.vx)<=.1&&Math.abs(this.direction.vy)<.1&&(this.direction.vx=0,this.direction.vy=0),this.direction.refresh()},BILLIARD.Ball.prototype.inHole=function(){if(this.type!=1)return!1;var a=!1,b=NaN,c=NaN;a=this.direction.p0.y<BILLIARD.Ball.w.y2-(BILLIARD.Ball.w.y2-BILLIARD.Ball.w.y1)/2,b=BILLIARD.Ball.w.x2-(BILLIARD.Ball.w.x2-BILLIARD.Ball.w.x1)/2,c=.707107;if(this.direction.p0.x<b+this.r/1.25&&this.direction.p0.x>b-this.r/1.25)return this.x=b,a?this.y=BILLIARD.Ball.w.y1-this.r/2:this.y=BILLIARD.Ball.w.y2+this.r/2,!0;if(this.direction.p0.y<BILLIARD.Ball.w.y1+this.r*1.3){if(this.direction.p0.x>BILLIARD.Ball.w.x2-this.r*1.3)return this.x=BILLIARD.Ball.w.x2-3,this.y=BILLIARD.Ball.w.y1+3,!0;if(this.direction.p0.x<BILLIARD.Ball.w.x1+this.r*1.3)return this.x=BILLIARD.Ball.w.x1+3,this.y=BILLIARD.Ball.w.y1+3,!0}else if(this.direction.p0.y>BILLIARD.Ball.w.y2-this.r*1.3){if(this.direction.p0.x>BILLIARD.Ball.w.x2-this.r*1.3)return this.x=BILLIARD.Ball.w.x2-3,this.y=BILLIARD.Ball.w.y2-3,!0;if(this.direction.p0.x<BILLIARD.Ball.w.x1+this.r*1.3)return this.x=BILLIARD.Ball.w.x1+3,this.y=BILLIARD.Ball.w.y2-3,!0}return!1},BILLIARD.Ball.prototype.updateDirection=function(a,b){this.direction.p1.update(a,b),this.direction.refresh(!0)},BILLIARD.Ball.prototype.move=function(a,b){this.x=a,this.y=b,this.direction.p0.update(a,b);return},BILLIARD.Ball.prototype.putBehindLine=function(){var a=NaN,b=NaN,c=BILLIARD.Ball.w,d=this.r;a=Math.random()*(c.x2-d-this.line_limit_x),b=Math.random()*(c.y2-d-(c.y1+d)),this.direction.vx=0,this.direction.vy=0,this.move(this.line_limit_x+a,c.y1+d+b),BILLIARD.Ball.isPositionOverlapped(this.x,this.y,this)!=null&&this.putBehindLine()},BILLIARD.Ball.prototype.startDragging=function(a){return;var b,c,d},BILLIARD.Ball.prototype.updateProccessTime=function(a){this.proccess_time=BILLIARD.Ball.correctFloatingPointError(a),this.vx=BILLIARD.Ball.correctFloatingPointError(this.direction.vx*this.proccess_time),this.vy=BILLIARD.Ball.correctFloatingPointError(this.direction.vy*this.proccess_time)},BILLIARD.Taco=function(a){this.moving=!1,this.holding=!1,this.hits=0,this.first_hit=null,this.vector_mouse=null,this.init_mouse=null,this.whiteBall=null,this.last_power_factor=null,this.maxPower=120,this.RAD_TO_DEG=180/Math.PI,this.DEG_TO_RAD=Math.PI/180,this.maxRadius=100;var b=this;this.keypress=!1,NEngine.Shape.call(this),this.name="taco",this.cacheCanvas=document.createElement("canvas"),this.image=new Image,this.image.onload=function(){b.cacheCanvas.width=b.image.width,b.cacheCanvas.height=b.image.height;var a=b.cacheCanvas.getContext("2d");a.drawImage(b.image,0,0),b.width=b.image.width,b.height=b.image.height,b.regX=b.image.width/2,b.regY=0},this.init_mouse=new BILLIARD.TriangleData,this.vector_mouse=new BILLIARD.TriangleData,this.onKeyDown=function(a){b.onPress(a)},this.onKeyUp=function(a){b.onRelease(a)},this.image.src=a},BILLIARD.Taco.inheritsFrom(NEngine.Shape),BILLIARD.Taco.prototype.draw=function(a,b){this.__draw(a,b)},BILLIARD.Taco.prototype.init=function(a){this.moving=!0,this.holding=!1,this.alpha=0,this.hits=0,this.whiteBall=a},BILLIARD.Taco.prototype.putOnBorder=function(a){typeof a=="undefined"&&(a=0);var b=this.rotation+Math.PI*.5,c=Math.cos(b),d=Math.sin(b),e=this.whiteBall.r+5+a;this.x=this.whiteBall.x+c*e,this.y=this.whiteBall.y+d*e},BILLIARD.Taco.prototype.updateState=function(){var a=null,b=NaN;this.moving&&(this.holding?(a=new BILLIARD.TriangleData,a.p0=new BILLIARD.SimplePoint(this.whiteBall.x,this.whiteBall.y),a.p1=new BILLIARD.SimplePoint(this.parent.mouseX,this.parent.mouseY),a.refresh(!0),b=a.len-this.init_mouse.len,a.len<=this.whiteBall.r||b<=0?this.putOnBorder():b<=this.maxRadius&&(this.vector_mouse.dx>0&&a.dx>0||this.vector_mouse.dx<0&&a.dx<0)&&this.putOnBorder(b)):(this.vector_mouse.p0=new BILLIARD.SimplePoint(this.whiteBall.x,this.whiteBall.y),this.vector_mouse.p1=new BILLIARD.SimplePoint(this.parent.mouseX,this.parent.mouseY),this.vector_mouse.refresh(!0),this.vector_mouse.dx<0?this.rotation=Math.PI/2+Math.atan(this.vector_mouse.vy/this.vector_mouse.vx):this.rotation=3*Math.PI/2+Math.atan(this.vector_mouse.vy/this.vector_mouse.vx),this.putOnBorder()))},BILLIARD.Taco.prototype.onPress=function(a){!this.keypress&&a.keyCode==81&&(this.init_mouse.p0=new BILLIARD.SimplePoint(this.whiteBall.x,this.whiteBall.y),this.init_mouse.p1=new BILLIARD.SimplePoint(this.parent.mouseX,this.parent.mouseY),this.init_mouse.refresh(!0),this.holding=!0,this.keypress=!0)},BILLIARD.Taco.prototype.onRelease=function(a){var b=null,c=NaN;this.whiteBall.dragging&&this.whiteBall.allowDrag(!1),this.holding&&(this.moving=!1,this.holding=!1,this.keypress=!1,b=new BILLIARD.TriangleData,b.p0=new BILLIARD.SimplePoint(this.whiteBall.x+this.init_mouse.dx*this.whiteBall.r,this.whiteBall.y+this.init_mouse.dy*this.whiteBall.r),b.p1=new BILLIARD.SimplePoint(this.x,this.y),b.refresh(!0),this.putOnBorder(),b.len>0&&this.whiteBall.direction.vx==0&&this.whiteBall.direction.vy==0&&(this.last_power_factor=b.len/this.maxRadius,c=this.last_power_factor*this.maxPower,this.first_hit=null,this.whiteBall.updateDirection(this.whiteBall.x+c*-this.init_mouse.dx,this.whiteBall.y+c*-this.init_mouse.dy),this.hits++))},BILLIARD.Taco.prototype.getDirection=function(){return new BILLIARD.SimplePoint(-this.vector_mouse.dx,-this.vector_mouse.dy)},BILLIARD.Main=function(a,b,c,d,e,f,g,h,i){this.c0_fake=null,this.c0=null,this.c1=null,this.c2=null,this.c3=null,this.c4=null,this.c5=null,this.c6=null,this.c7=null,this.c8=null,this.c9=null,this.c10=null,this.c11=null,this.c12=null,this.c13=null,this.c14=null,this.c15=null,this.balls=[],this.balls_removed=[],this.DEG_TO_RAD=Math.PI/180,this.RAD_TO_DEG=180/Math.PI,this.lines=null,this.taco=null,this.diff=null,this.tri=null;var j=this;this.canvas=a,this.width=585,this.height=365,this.fps=12,NEngine.env.interval=1e3/this.fps,NEngine.Stage.call(this,this.canvas),this.frenchtable=new NEngine.Bitmap(d,0,0),this.americantable=new NEngine.Bitmap(c,0,0),this.taco=new BILLIARD.Taco(i),this.white=e,this.black=f,this.red=h,this.yellow=g,BILLIARD.Ball.isPositionOverlapped=function(a,b,c){typeof c=="undefined"&&(c=null),j.tri=new BILLIARD.TriangleData,j.tri.p0.x=a,j.tri.p0.y=b;var d=0;while(d<j.balls.length){if(c!=j.balls[d]){j.tri.p1=j.balls[d].direction.p0,j.tri.refresh(!0),j.diff=BILLIARD.Ball.correctFloatingPointError(j.tri.len-j.balls[d].r*2);if(j.diff<0)return alert("ERROR!! ball["+c.name+"] is overlapping with ["+j.balls[d].name+"] by "+j.diff+" pixels."),j.balls[d]}d++}return null},this.stagetick=this.tick,this.init(b)},BILLIARD.Main.inheritsFrom(new NEngine.Stage(document.createElement("canvas"))),BILLIARD.Main.prototype.addBall=function(a){a.updateDirection(a.x,a.y),this.balls.push(a)},BILLIARD.Main.prototype.init=function(a){this.type=a;var b=this;this.tick=this.stagetick,this.balls=[],this.balls_removed=[];while(this.numChildren>0)this.removeChildAt(0);this.type==1?this.addChild(this.americantable):this.addChild(this.frenchtable),this.c0_fake=new BILLIARD.Ball(this.white,this.type),this.c0_fake.name="c0_fake",this.c0_fake.colour=0,this.c0_fake.alpha=.5,this.addChild(this.c0_fake),this.c0=new BILLIARD.Ball(this.white,this.type),this.c0.name="c0",this.c0.colour=0;if(this.type==1){var c=1;while(c<=15)this["c"+c]=null,c==8?(this["c"+c]=new BILLIARD.Ball(this.black,this.type),this["c"+c].colour=1):c<8?(this["c"+c]=new BILLIARD.Ball(this.yellow,this.type),this["c"+c].colour=2):c>8&&(this["c"+c]=new BILLIARD.Ball(this.red,this.type),this["c"+c].colour=3),this["c"+c].name="c"+c,c++}else this.c1=new BILLIARD.Ball(this.black,this.type),this.c1.name="c1",this.c1.colour=1,this.c2=new BILLIARD.Ball(this.red,this.type),this.c2.name="c2",this.c2.colour=3,this.c3=new BILLIARD.Ball(this.yellow,this.type),this.c3.name="c3",this.c3.colour=2;this.c0.x=471,this.c0.y=98,this.c0.direction.p0.update(this.c0.x,this.c0.y),this.addChild(this.c0),this.addBall(this.c0);if(this.type==1){this.c1.x=311,this.c1.y=248,this.c2.x=287,this.c2.y=262,this.c3.x=239,this.c3.y=289,this.c4.x=215,this.c4.y=248,this.c5.x=239,this.c5.y=234,this.c6.x=263,this.c6.y=221,this.c7.x=215,this.c7.y=194,this.c8.x=263,this.c8.y=248,this.c9.x=287,this.c9.y=234,this.c10.x=215,this.c10.y=221,this.c11.x=239,this.c11.y=207,this.c12.x=263,this.c12.y=276,this.c13.x=239,this.c13.y=262,this.c14.x=215,this.c14.y=276,this.c15.x=215,this.c15.y=303;for(var d=1;d<16;d++)this["c"+d].x-=107,this["c"+d].y-=66,this["c"+d].direction.p0.update(this["c"+d].x,this["c"+d].y),this.addChild(this["c"+d]),this.addBall(this["c"+d])}else this.c1.x=200,this.c1.y=this.height/2,this.c1.direction.p0.update(this.c1.x,this.c1.y),this.addChild(this.c1),this.addBall(this.c1),this.c2.x=200,this.c2.y=50,this.c2.direction.p0.update(this.c2.x,this.c2.y),this.addChild(this.c2),this.addBall(this.c2),this.c3.x=200,this.c3.y=this.height-50,this.c3.direction.p0.update(this.c3.x,this.c3.y),this.addChild(this.c3),this.addBall(this.c3);this.c0.putBehindLine(),this.taco.init(this.c0),this.addChild(this.taco),this.tick=function(){b.onEnterFrame()}},BILLIARD.Main.prototype.onEnterFrame=function(a){var b=0,c=!1,d=NaN,e=NaN,f=NaN,g=NaN,h=NaN,i=NaN,j=!1,k=null,l=null,m=null,n=null,o=undefined;c=!1,b=0;while(b<this.balls.length)this.balls[b].updateProccessTime(1),this.balls[b].direction.len>0&&(c=!0),b++;if(c){d=0,e=0,f=1,g=0,h=0;while(f>0&&c){c=!1,b=0;while(b<this.balls.length)this.balls[b].collision=!1,this.balls[b].target=null,this.balls[b].collision_wall_detail=null,this.balls[b].collision_target_time=Infinity,k=this.getBallsInCollision(this.balls[b]),k.length>0&&(this.balls[b].target=k[0],this.balls[b].collision_target_time=k[0].last_collision_time),l=BILLIARD.Ball.findTimeUntilCollideWithWall(this.balls[b]),l.x>=0&&l.x<1&&(this.balls[b].collision_target_time==Infinity||l.x<this.balls[b].collision_target_time)&&(this.balls[b].collision_target_time=l.x,this.balls[b].collision_wall_detail=l,this.balls[b].target=null),b++;this.balls.sort(this.sortByTargetCollisionTime),i=1,j=!1,b=0;while(b<this.balls.length){m=this.balls[b];if(m.direction.len>0&&!m.collision){n=m.target;if(n==null||n.target!=m||i!=1&&i!=m.collision_target_time)if(m.collision_wall_detail==null||i!=1&&i!=m.collision_target_time)c=!0,m.move(m.direction.p0.x+m.vx*i,m.direction.p0.y+m.vy*i),m.updateProccessTime(m.proccess_time-m.proccess_time*i),m.affectSpeed(.975),m.target=null,m.collision_target_time=Infinity,j||(f=BILLIARD.Ball.correctFloatingPointError(f-f*i),j=!0);else{i=m.collision_target_time,m.move(m.direction.p0.x+m.vx*.9999*i,m.direction.p0.y+m.vy*.9999*i);if(!m.inHole())c=!0,BILLIARD.Ball.doElasticCollisionWithWall(m,m.collision_wall_detail),m.collision=!0,m.updateProccessTime(m.proccess_time-m.proccess_time*i),m.affectSpeed(.925);else{o=0;while(o<this.balls.length){if(this.balls[o]==m){m.status=1,this.balls_removed.push(m),this.balls.splice(o,1),b-=1,m.colour==1&&(this.balls.length==0||this.balls.length>1||this.balls.length==1&&this.balls[0].colour!=0)&&(this.c0.status=2);break}o+=1}}j||(f=BILLIARD.Ball.correctFloatingPointError(f-f*i),j=!0)}else c=!0,d==0&&(e=Math.max(m.direction.len,n.direction.len)/50,e>1&&(e=1),this.taco.first_hit==null&&(m.name=="c0"||n.name=="c0")&&(this.taco.first_hit=m.name=="c0"?n:m)),d+=1,i=m.collision_target_time,g=m.direction.p0.x+m.vx*.9999*i,h=m.direction.p0.y+m.vy*.9999*i,m.move(g,h),g=n.direction.p0.x+n.vx*.9999*i,h=n.direction.p0.y+n.vy*.9999*i,n.move(g,h),BILLIARD.Ball.doElasticCollision(m,n),m.updateProccessTime(m.proccess_time-m.proccess_time*i),m.collision=!0,m.affectSpeed(.96),n.updateProccessTime(n.proccess_time-n.proccess_time*i),n.collision=!0,n.affectSpeed(.96),m.target=null,m.collision_target_time=Infinity,n.target=null,n.collision_target_time=Infinity,j||(f=BILLIARD.Ball.correctFloatingPointError(f-f*i),j=!0)}b++}}}if(this.balls_removed.length>0){b=0;while(b<this.balls_removed.length)this.balls_removed[b].alpha<=0?(this.balls_removed[b].visible=!1,this.balls_removed.splice(b,1),b-=1):this.balls_removed[b].alpha=this.balls_removed[b].alpha-.1,b++}else!this.taco.moving&&!c&&(this.c0.status!=0||!!this.c0.dragging)&&this.c0.status==1&&(this.c0.putBehindLine(),this.c0.visible=!0,this.c0.alpha=1,this.c0.status=0,this.balls.push(this.c0)),this.taco.moving=!c&&this.c0.status==0&&!this.c0.dragging,this.c0_fake.visible=!1,this.taco.moving?(this.drawLines(),this.taco.updateState(),this.taco.alpha<1?this.taco.alpha=this.taco.alpha+.025:this.taco.alpha=1):this.taco.alpha>0?this.taco.alpha=this.taco.alpha-.025:this.taco.alpha=0;this.stagetick()},BILLIARD.Main.prototype.getBallsInCollision=function(a){var b=null,c=0,d=NaN;a.last_collision_time=Infinity,b=[],c=0;while(c<this.balls.length)this.balls[c]!=a&&(this.balls[c].last_collision_time=Infinity,d=BILLIARD.Ball.findTimeUntilCollide(a,this.balls[c]),d>=0&&d<1&&(b.length==0||b[0].last_collision_time>d)&&(this.balls[c].last_collision_time=d,b[0]=this.balls[c])),c++;return b},BILLIARD.Main.prototype.drawLines=function(){var a=null,b=null,c=NaN,d=NaN,e=NaN,f=NaN,g=null,h=0,i=NaN,j=null,k=null;a=new BILLIARD.TriangleData,a.p0=new BILLIARD.SimplePoint(this.c0.direction.p0.x,this.c0.direction.p0.y),this.c0_fake.move(this.c0.direction.p0.x,this.c0.direction.p0.y),b=this.taco.getDirection(),this.c0_fake.updateDirection(this.c0_fake.direction.p0.x+b.x,this.c0_fake.direction.p0.y+b.y),this.c0_fake.updateProccessTime(1),c=this.c0_fake.direction.dx,d=this.c0_fake.direction.dy,e=this.c0_fake.direction.len,f=-1,h=0;while(h<this.balls.length)this.balls[h]!=this.c0&&(i=BILLIARD.Ball.findTimeUntilCollide(this.c0_fake,this.balls[h]),i>=0&&(f==-1||i<f)&&(f=i,g=this.balls[h])),h++;f==-1&&(j=BILLIARD.Ball.findTimeUntilCollideWithWall(this.c0_fake),f=j.x),f>0&&(this.c0_fake.move(this.c0_fake.direction.p0.x+c*e*f,this.c0_fake.direction.p0.y+d*e*f),this.c0_fake.visible=!0,a.p1=new BILLIARD.SimplePoint(this.c0_fake.direction.p0.x,this.c0_fake.direction.p0.y),a.refresh(!0),k=null,g!=null&&(k=BILLIARD.Ball.simulateElasticCollision(this.c0_fake,g)),k!=null&&(a.p0.x=this.c0_fake.direction.p0.y,a.p0.y=this.c0_fake.direction.p0.y,a.vx=k.p0.x,a.vy=k.p0.y,a.refresh(),a.p0.x=g.direction.p0.x,a.p0.y=g.direction.p0.y,a.vx=k.p1.x,a.vy=k.p1.y,a.refresh()))},BILLIARD.Main.prototype.sortByTargetCollisionTime=function(a,b){return a.collision_target_time>b.collision_target_time?1:a.collision_target_time<b.collision_target_time?-1:0},BILLIARD.Main.prototype.sortByTime=function(a,b){return a.last_collision_time>b.last_collision_time?1:a.last_collision_time<b.last_collision_time?-1:0}